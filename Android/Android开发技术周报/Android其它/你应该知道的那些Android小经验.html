<html>
<head>
  <title>你应该知道的那些Android小经验</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/10.0.15063 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1978"/>
<h1>你应该知道的那些Android小经验</h1>

<div>
<span><div style="-evernote-webclip:true"><br/></div><div><div><h1>你应该知道的那些Android小经验</h1></div><div><em>2016-03-20</em> <em>冯建</em> <a target="_blank">Android程序员</a></div><blockquote><p>今天是冯建同学投稿，总结他在Android开发方面的各种小经验，我觉得非常有意义，所谓经验丰富有时候是指积累的这些小经验非常多，他这篇分享相信会帮助到一些朋友。我也曾推荐过他的 <a href="http://mp.weixin.qq.com/s?__biz=MzA4MjU5NTY0NA==&amp;mid=402168736&amp;idx=1&amp;sn=723e9fddacfecdfbeee3d3365f6d1a2f&amp;scene=21#wechat_redirect" target="_blank">APK魔鬼瘦身</a> 一文，没看过的朋友也可以再去看看。</p></blockquote><p>做Android久了，就会踩很多坑，被坑得多了就有经验了，闲暇之余整理了部分，现挑选一些重要或者偏门的“小”经验做个记录。</p><h3>查看SQLite日志</h3></div><div><img src="你应该知道的那些Android小经验_files/Image.png" type="image/png" data-filename="" style="height: auto;"/></div><div>因为实现里用了Log.isLoggable(TAG, Log.VERBOSE)做了判断，在LessCode的LogLess中也参考了这种机制：https://github.com/openproject/LessCode/blob/master/lesscode-core/src/main/java/com/jayfeng/lesscode/core/LogLess.java
<p>使用这种方法就可以在Release版本也能做到查看应用的打印日志了。</p><h3>PNG优化</h3><p>APK打包会自动对PNG进行无损压缩，如果自行无损压缩是无效的。<br/>
当然进行有损压缩是可以的：https://tinypng.com/</p><h3>Tcpdump抓包</h3><p>有些模拟器比如genymotion自带了tcpdump，如果没有的话，需要下载tcpdump:<br/>
http://www.strazzere.com/android/tcpdump</p><p>把tcpdump push到/data/local下，抓包命令：</p></div><div><img src="你应该知道的那些Android小经验_files/Image [1].png" type="image/png" data-filename="" style="height: auto;"/></div><div>很多开发者服务都需要绑定签名信息，用下面的命令可以查看签名：</div><div><img src="你应该知道的那些Android小经验_files/Image [2].png" type="image/png" data-filename="" style="height: auto;"/></div><div>注意，这个是需要密码的，可以查看MD5, SHA1，SHA256等等。</div><div><h3>单例模式(懒汉式)的最佳写法</h3><p>特别说到这个问题，是因为网上很多这样的代码：</p><div><img src="你应该知道的那些Android小经验_files/640.jpg" type="image/jpeg" data-filename="640.jpg" height="287" style="height: auto;" width="576"/></div>
这种写法线程不安全，改进一下，加一个同步锁：
<div><img src="你应该知道的那些Android小经验_files/Image [3].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div></div><div>网上这样的代码更多，可以很好的工作，但是缺点是效率低。</div><div>实际上，早在JDK1.5就引入volatile关键字，所以又有了一种更好的双重校验锁写法：</div><div><img src="你应该知道的那些Android小经验_files/Image [4].png" type="image/png" data-filename="Image.png" style="height: auto;"/></div><div>这才是最佳写法！！！</div><div><p>不是说第二种写法有问题，或者在Android中一定要用第三种写法，只是告诉大家一种更好的写法。</p><h3>多进程Application</h3><p>是不是经常发现Application里的方法执行了多次？百思不得其解。</p><p>因为当有多个进程的时候，Application会执行多次，可以通过pid来判断那些方法只执行一次，避免浪费资源。</p><h3>隐式启动Service</h3><p>这是Android5.0的一个改动，不支持隐式的Service调用。下面的代码在Android 5.0+上会报错：Service Intent must be explicit：</p></div><div><img src="你应该知道的那些Android小经验_files/Image [5].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/><img src="你应该知道的那些Android小经验_files/Image [6].png" type="image/png" data-filename="" style="height: auto;"/></div><div>可改成如下：</div><div><img src="你应该知道的那些Android小经验_files/Image [7].png" type="image/png" data-filename="" style="height: auto;"/></div><div><div><img src="你应该知道的那些Android小经验_files/Image [8].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><h3>fill_parent的寿命</h3><p>在Android2.2之后，支持使用match_parent。你的布局文件里是不是既有fill_parent和match_parent显得很乱？</p><p>如果你现在的minSdkVersion是8+的话，就可以忽略fill_parent，统一使用match_parent了，否则请使用fill_parent。</p><h3>ListView的局部刷新</h3><p>有的列表可能notifyDataSetChanged()代价有点高，最好能局部刷新。</p><p>局部刷新的重点是，找到要更新的那项的View，然后再根据业务逻辑更新数据即可。</p><div><img src="你应该知道的那些Android小经验_files/Image [9].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div>
强调一下，最后那个列表数据别忘记更新， 不然数据源不变，一滚动可能又还原了。
<h3>系统日志中几个重要的TAG</h3></div><div><img src="你应该知道的那些Android小经验_files/Image [10].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/><img src="你应该知道的那些Android小经验_files/Image [11].png" type="image/png" data-filename="" style="height: auto;"/></div><div><h3>一行居中，多行居左的TextView</h3><p>这个一般用于提示信息对话框，如果文字是一行就居中，多行就居左。<br/>
在TextView外套一层wrap_content的ViewGroup即可简单实现：</p><div><img src="你应该知道的那些Android小经验_files/Image [12].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><h3>setCompoundDrawablesWithIntrinsicBounds()</h3><p>网上一大堆setCompoundDrawables()方法无效不显示的问题，然后解决方法是setBounds，需要计算大小…</p><p>不用这么麻烦，用setCompoundDrawablesWithIntrinsicBounds()这个方法最简单！</p><h3>计算程序运行时间</h3><p>为了计算一段代码运行时间，一般的做法是，在代码的前面加个startTime，在代码的后面把当前时间减去startTime，这个时间差就是运行时间。</p><p>这里提供一种写起来更方便的方法，完全无时间逻辑，只是加一个打印log就够了。</p><div><img src="你应该知道的那些Android小经验_files/Image [13].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div>
没有计算时间的逻辑，这能测出来？
<p>把日志过滤出来，运行命令“adb logcat -v time | grep TAG”：</p><div><img src="你应该知道的那些Android小经验_files/Image [14].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div>
通过-v time参数，可以比较日志左边的时间来算出中间的代码运行的时间。</div><div><br/></div><div style="font-weight: bold; font-size: 20px;">Java引用类型一览表</div><div><img src="你应该知道的那些Android小经验_files/Image [15].png" type="image/png" data-filename="" style="height: auto;"/></div><div><div><img src="你应该知道的那些Android小经验_files/Image [16].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><h3>Context使用场景</h3><p>为了防止Activity，Service等这样的Context泄漏于一些生命周期更长的对象，可以使用生命周期更长的ApplicationContext，但是不是所有的Context的都能替换为ApplicationContext</p></div><div>这是网上流传的一份表格：</div><div><img src="你应该知道的那些Android小经验_files/Image [17].png" type="image/png" data-filename="" style="height: auto;"/></div><div><div><img src="你应该知道的那些Android小经验_files/Image [18].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><h3>图片缓存大小</h3><p>现在很多图片库需要给图片设置一个最大缓存，但是这个值设置多少合适呢？</p><p>高端机和低端机的配置显然应该不同，可以考虑设置一个动态值。</p><p>建议设置为应用可用内存的1/8:</p><div><img src="你应该知道的那些Android小经验_files/Image [19].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><h3>系统内置的一些工具类</h3></div><div>在AOSP源码全局搜了一下包含Util关键字的类，整理出这个列表供大家参考：</div><div><img src="你应该知道的那些Android小经验_files/Image [20].png" type="image/png" data-filename="" style="height: auto;"/></div><div><div><img src="你应该知道的那些Android小经验_files/Image [21].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><p>这么多工具类，一定可以找到对你有用的。</p><h3>ClipPadding</h3><p>这个不多说，ListView的ClipPadding设为false，就能为ListView设置各种padding而不会出现丑陋的滑动“禁区”了。</p><h3>强大的dumpsys</h3><p>dumpsys可以查看系统服务和状态，非常强大，可通过如下查看所有支持的子命令：<br/><img src="你应该知道的那些Android小经验_files/Image [22].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/><br/>
这里列举几个稍微常用的：</p><div><img src="你应该知道的那些Android小经验_files/Image [23].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><h3>bugreport命令</h3><p>很多人都用过adb logcat，但是如果想要更详细的信息，logcat则无能为力。</p><p>所以大多数手机厂商测试更多的是用adb bugreport来抓log给开发人员分析。</p><div><img src="你应该知道的那些Android小经验_files/Image [24].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div></div><div><br/></div><div style="font-weight: bold; font-size: 20px;">dpi文件夹的换算比例</div><div><img src="你应该知道的那些Android小经验_files/Image [25].png" type="image/png" data-filename="" style="height: auto;"/></div><div><div><img src="你应该知道的那些Android小经验_files/Image [26].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div><h3>更新媒体库文件</h3><p>以前做ROM的时候经常碰到一些第三方软件（某音乐APP）下载了新文件或删除文件之后，但是媒体库并没有更新，因为这个是需要第三方软件主动触发。</p><div><img src="你应该知道的那些Android小经验_files/Image [27].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/></div>
媒体库会在手机启动，SD卡插拔的情况下进行全盘扫描，不是实时的而且代价比较大，所以单个文件的刷新很有必要。
<h3>Monkey参数</h3></div><div>大家都知道，跑monkey的参数设置有一些要注意的地方，比如太快了不行不切实际，太慢了也不行等等，这里给出一个参考：</div><div><br/></div><div><img src="你应该知道的那些Android小经验_files/Image [28].png" type="image/png" data-filename="" height="1" style="height: auto;" width="1"/><img src="你应该知道的那些Android小经验_files/Image [29].png" type="image/png" data-filename=""/></div><div>一边跑monkey，一遍抓log吧。
<p>无论是大经验还是小经验，都是好经验，关键时候出奇效。</p><blockquote><p>本文为原创文章，未经允许禁止转载</p></blockquote><hr/><p>如果喜欢这篇，欢迎帮助转发，点击阅读原文，可直接访问作者博客 jayfeng.com</p></div><div style="-evernote-webclip:true"><br/></div></span>
</div></body></html> 