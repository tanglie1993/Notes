<html>
<head>
  <title>泰晓科技 - Android 加载不同 DPI 资源与内存消耗间的关系</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/10.0.15063 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1566"/>
<h1>泰晓科技 - Android 加载不同 DPI 资源与内存消耗间的关系</h1>

<div><span><div style="-evernote-webclip:true"><br/><div><div><div><div><h1>Android 加载不同 DPI 资源与内存消耗间的关系</h1><div><div></div></div></div><blockquote><p>by Will of <a href="http://tinylab.org/" target="_blank">TinyLab.org</a>
2015/04/21
</p></blockquote><h2><span>1</span> Android DPI 分级标准简介</h2><p>Android 设备在物理尺寸和屏幕密度上都有很大的不同，为了简化多设备的设计方案，就是设定一套分级标准。屏幕密度上的分级标准就是：LDPI、MDPI、HDPI、XHDPI，也就是各种大小的 DPI(Dots per inch)。<strong>DPI 就是屏幕像素密度的衡量标准</strong>。</p><h2><span>2</span> 不同设备共享同一套 DPI 资源有哪些问题？</h2><p>现在进入正题。</p><p><strong>Q</strong>：不少公司出于简化设计和研发的目的，往往在方案中只使用一套 DPI 资源，这样做可不可行呢？</p><p><strong>A</strong>：Android 有一套加载资源的规则，如果对应的 DPI 文件夹不存在要用的资源就会按照规则去找其它的DPI 文件夹，如果最终能找到就可以使用。所以上述方案是“可行的”– 可以正常运行不报错的。那可行性的另一个方面就是对性能有没有影响。上述问题就变为下面问题：</p><p><strong>Q</strong>：同一套 DPI 资源在不同手机上使用时内存消耗有什么不同？ 或 App 中加载不同 DPI 文件夹中的资源内存消耗有什么不同？</p><h2><span>3</span> 问题：DPI 越小的文件夹内存消耗越大？</h2><p>下面以 png 图片的加载为例。</p><p></p><div><img src="泰晓科技 - Android 加载不同 DPI 资源与内存消耗间的关系_files/26d2fc94-ba91-4c55-b1c4-ce035ef7177a.png" type="image/png" data-filename="26d2fc94-ba91-4c55-b1c4-ce035ef7177a.png" alt="demo pic" height="960" width="540"/></div><p></p><p>原始图片（attribute—width:960，height:540，bit depth:32，size:217082bytes）。</p><p>做简单的 demo app，即在 activity 中只加载这一个图片。</p><p>放在 hdpi 文件夹中，dumpsys meminfo 后发现 Heap Alloc 为 5420，远远大于 size，所以先肯定的是内存消耗与图片文件大小无关。</p><p>再放到不同的 DPI 文件夹中发现：<strong>越是 DPI 小的文件夹内存消耗越大！</strong></p><h2><span>4</span> 分析：加载低 DPI 资源会额外拉伸放大图片</h2><p>由于 Heap Alloc 只能看到堆的分配总体大小，不能看到上述发现有什么“规律”，所以接着使用 MAT 分析。</p><p>在 hdpi 中抓取 hprof 文件，用 MAT 打开：</p><p></p><div><img src="泰晓科技 - Android 加载不同 DPI 资源与内存消耗间的关系_files/3ff8480d-a250-44a0-82d9-5d3e028d4313.png" type="image/png" data-filename="3ff8480d-a250-44a0-82d9-5d3e028d4313.png" alt="mat" height="427" width="576"/></div><p></p><p>见图中的 byte 数组，大小为 2073600，这个大小就是加载的那张 png 图片占用的内存大小。</p><p>分别分析图片资源放在 mdpi、ldpi 和 xhdpi 时的 hprof 文件，byte 数组大小分别为：4665600、8294400、1166400。不同 DPI 文件夹与图片占用的内存大小关系如下：</p><table><tbody><tr><td>DPIs</td><td>ldpi</td><td>mdpi</td><td>hdpi</td><td>xhdpi</td></tr><tr><td>Byte[] size</td><td>8294400</td><td>4665600</td><td>2073600</td><td>1166400</td></tr><tr><td>Ratio</td><td>8^2</td><td>6^2</td><td>4^2</td><td>3^2
</td></tr></tbody></table><p>开始就说到 Android 的屏幕密度的分级标准是 LDPI、MDPI、HDPI、XHDPI 这些各种大小的 DPI。也就是 LDPI 的设备默认使用的是 ldpi 文件夹下的资源。根据 DPI 值的大小再整理一下，屏幕像素密度的值对应使用的 DPI 文件夹关系如下：</p><table><tbody><tr><td>DPIs</td><td>ldpi</td><td>mdpi</td><td>hdpi</td><td>xhdpi</td></tr><tr><td>Density</td><td>120</td><td>160</td><td>240</td><td>320</td></tr><tr><td>Ratio</td><td>3</td><td>4</td><td>6</td><td>8
</td></tr></tbody></table><p>根据上面两个表格的 Ratio 值，可以发现内存占用和 DPI 资源是有一定规律的。<strong>其实我们知道 png 加载内存的消耗与文件大小无关，而是与 png 图片的长宽和位深有关</strong>，也就是：</p><pre><ol><li>MemoryConsumptionWidthHeight depth </li></ol></pre><p>上面公式是不能完全在 Android 中使用的，根据上述找到的规律，Android 中 png 图片内存消耗公式可以概括为：</p><pre><ol><li>MemoryConsumptionScaledWidthScaledHeight depth ScaledWidthWidth factor</li><li>ScaledHeightHeight factor</li><li>factor  DENSITY_DEVICE ResourceDensity// DENSITY_DEVICE 是设备的 DPI 大小， ResourceDensity 是设备加载的 DPI 文件夹对应的 DPI 大小</li></ol></pre><pre><ol><li>MemoryConsumptionWidthHeightDENSITY_DEVICE ResourceDensity depth </li></ol></pre><p>上述 hdpi 中的 2073600 可以由此计算得出:</p><pre><ol><li>2073600</li></ol></pre><p>在 BitmapFactory.cpp 的 doDecode() 中 添加 log ，可验证上述公式(资源在 xdpi 中，sx、sy 就是上述公式中的 factor)：</p><pre><ol><li>49.479BitmapFactory doDecode0.7500000.750000scaledWidthscaledHeightdecodingBitmapwidthdecodingBitmapheigth</li></ol></pre><p><strong>Android 加载资源默认选用和设备 DPI 匹配的资源，如果没有就去到其它 DPI 文件夹中寻找资源。找到后它会认为使用了不同 DPI 的资源，为了保持与设备 DPI 一致，就会对资源做拉伸或缩放处理再加载</strong>。下面是上述 png 图片分别放在 mdpi 和 xxhdpi 文件夹下的截图：</p><table><thead><tr><th><div><img src="泰晓科技 - Android 加载不同 DPI 资源与内存消耗间的关系_files/939c07e4-1880-49fa-aa04-cda4b0d410b4.png" type="image/png" data-filename="939c07e4-1880-49fa-aa04-cda4b0d410b4.png" alt="mdpi" height="332" width="278"/></div></th><th><div><img src="泰晓科技 - Android 加载不同 DPI 资源与内存消耗间的关系_files/8b2caec5-3440-4556-911c-1049b21c3168.png" type="image/png" data-filename="8b2caec5-3440-4556-911c-1049b21c3168.png" alt="xxhdpi" height="565" width="369"/></div></th></tr></thead><tbody><tr><td>mdpi</td><td>xxhdpi
</td></tr></tbody></table><p>很明显就可以看到在 xxhdpi 下时的截图模糊了不少。使用的测试手机是 hdpi 的，但是默认 hdpi 找不到图片资源，它就会按照一定规则找到我放在 xxhdpi 中的资源。手机认为从 xxhdpi 获取的资源比手机的 dpi 要高，它就会按照表格中的比例把资源缩小，也就是加载到内存中的图片资源已经是原来大小的 1/2，占用的内存当然会缩小不做缩放操作图片的 1/4。但是坏处也是显而易见的，显示到手机的图片资源清晰度下降，模糊了很多。</p><p>相反的，hdpi 的手机加载低 dpi 资源，例如 ldpi，加载到内存前会先按比例拉伸。拉伸后再显示到手机中清晰度是没有问题，但是内存占用确增大为原来的 4 倍！<strong>还是要注意到这一点，如果图片资源在 app 中放错 dpi 文件夹，使用体验会大打折扣</strong>，或者尽量使用 9patch 图片。</p><h2><span>5</span> 小结：建议根据设备配置 DPI 资源</h2><p>现在就可以回答提出的问题了：</p><p><strong>Q</strong>：同一套 DPI 资源在不同手机上使用时内存消耗有什么不同？ 或 App 中加载不同 DPI 文件夹中的资源内存消耗有什么不同？</p><p><strong>A</strong>：不要使用一套资源适用于各种不同 DPI 的设备，这样图片的清晰度和内存消耗都会有问题。这就是为什么 Android 要求对不同 DPI 文件做不同的资源，并且不同 DPI 资源的长宽比要与 DPI Ratio 相对应。</p><p>PS：此文结论一句话就能给说清楚，但推导的过程更重要。爱因斯坦说过：<code>Imagination is more important than knowledge</code>.</p><h2><span>6</span> 参考资料</h2><p>参考的 Android 源码:</p><pre><ol><li>/frameworks/androidDisplayMetrics</li><li>frameworksgraphicsandroidgraphicsBitmap</li><li>frameworksgraphicsandroidgraphicsdrawableBitmapDrawable</li><li>frameworksandroidgraphicsBitmapFactory</li></ol></pre></div></div></div><br/></div></span>
</div></body></html> 