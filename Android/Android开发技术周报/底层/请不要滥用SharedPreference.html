<html>
<head>
  <title>请不要滥用SharedPreference</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/10.0.15063 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3140"/>
<h1>请不要滥用SharedPreference</h1>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="box-sizing:inherit;font-family:sans-serif;text-size-adjust:100%;"><div style="box-sizing:inherit;font-family:Lato, &quot;Microsoft Jhenghei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:16px;line-height:1.7;color:rgb(85, 85, 85);background:rgb(255, 255, 255);"><div style="box-sizing:inherit;"><span style="box-sizing:inherit;"><div style="box-sizing:inherit;"><div style="box-sizing:inherit;"><div style="box-sizing:inherit;"><div style="opacity:1;box-sizing:inherit;transform:translateY(0px);">
    <div style="box-sizing:inherit;display:block;">

      
      
        <h1 style="box-sizing:inherit;margin:20px 0px 10px;padding:0px;line-height:1;font-family:Cambria, Georgia, &quot;Microsoft Jhenghei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Times New Roman&quot;, serif;font-size:28px;font-weight:300;text-align:center;">
          
          
            
              请不要滥用SharedPreference
            
          
        </h1>
      

      <div style="box-sizing:inherit;margin:3px 0px 60px;color:rgb(153, 153, 153);font-size:12px;text-align:center;margin-top:5px;margin-bottom:60px;">
        <span style="box-sizing:inherit;">
          发表于
          <span style="box-sizing:inherit;">
            2016-10-13
          </span>
        </span>

        

        
          
        

      
      <span style="box-sizing:inherit;">  |  
      <span style="box-sizing:inherit;">10877</span>次阅读
      </span>    
      

      </div>
    </div>

    <div style="box-sizing:inherit;text-align:justify;">

      
      

      
        <span style="box-sizing:inherit;"><p style="box-sizing:inherit;margin:0px 0px 25px;">SharedPreference是Android上一种非常易用的轻量级存储方式，由于其API及其友好，得到了很多很多开发者的青睐。但是，SharedPreference并不是万能的，如果把它用在不合适的使用场景，那么将会带来灾难性的后果；本文将讲述一些SharedPreference的使用误区。</p>
<h2 style="box-sizing:inherit;margin:20px 0px 10px;padding:0px;font-weight:bold;line-height:1;font-family:Cambria, Georgia, &quot;Microsoft Jhenghei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Times New Roman&quot;, serif;font-size:22px;padding-top:10px;">存储超大的value</h2><p style="box-sizing:inherit;margin:0px 0px 25px;">第一次看到下面这个sp的时候，我的内心是崩溃的：</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;"><a href="http://7xp3xc.com1.z0.glb.clouddn.com/201601/1476286071563.png" style="box-sizing:inherit;background-color:transparent;color:rgb(34, 34, 34);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;border-bottom-color:rgb(204, 204, 204);"><img src="请不要滥用SharedPreference_files/1476286071563.png" type="image/png" data-filename="1476286071563.png" height="59" style="max-width:100%;height:auto;cursor:-webkit-zoom-in;border:1px solid rgb(221, 221, 221);box-sizing:border-box;padding:3px;margin:0px auto;display:block;" width="664"/></a></p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">一个默认的sp有90K，当我打开它的时候，我都快哭了：除了零零星星的几个很小的key之外，存储了一个炒鸡大的key，这一个key至少占了其中的89K。知道这是什么概念吗？</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">在小米1S这种手机上，<strong style="box-sizing:inherit;font-weight:bold;">就算获取这个sp里面一个很小的key，会花费120+ms！！</strong>那个毫不相干的key拖慢了其他所有key的读取速度！当然，在性能稍好的手机上，这个问题不是特别严重。但是要知道，120ms这个是完全不能忍的！</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">之所以说SharedPreference（下文简称sp）是一种轻量级的存储方式，是它的设计所决定的：sp在创建的时候会把整个文件全部加载进内存，如果你的sp文件比较大，那么会带来两个严重问题：</p>
<ol style="box-sizing:inherit;">
<li style="box-sizing:inherit;">第一次从sp中获取值的时候，有可能阻塞主线程，使界面卡顿、掉帧。</li>
<li style="box-sizing:inherit;">解析sp的时候会产生大量的临时对象，导致频繁GC，引起界面卡顿。</li>
<li style="box-sizing:inherit;">这些key和value会永远存在于内存之中，占用大量内存。</li>
</ol>
<a style="box-sizing:inherit;background-color:transparent;color:rgb(34, 34, 34);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;border-bottom-color:rgb(204, 204, 204);"></a>
<p style="box-sizing:inherit;margin:0px 0px 25px;">也许有童鞋会说，sp的加载不是在子线程么，怎么会卡住主线程？子线程IO就一定不会阻塞主线程吗？</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">下面是默认的sp实现SharedPreferenceImpl这个类的getString函数：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">public</span> String <span style="box-sizing:inherit;color:rgb(62, 153, 159);">getString</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">(String key, @Nullable String defValue)</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">synchronized</span> (<span style="box-sizing:inherit;color:rgb(137, 89, 168);">this</span>) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        awaitLoadedLocked();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        String v = (String)mMap.get(key);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">return</span> v != <span style="box-sizing:inherit;color:rgb(137, 89, 168);">null</span> ? v : defValue;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">继续看看这个awaitLoadedLocked：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">8</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">private</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">void</span> <span style="box-sizing:inherit;color:rgb(62, 153, 159);">awaitLoadedLocked</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">()</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">while</span> (!mLoaded) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">try</span> {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            wait();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        } <span style="box-sizing:inherit;color:rgb(137, 89, 168);">catch</span> (InterruptedException unused) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">一把锁就是挂在那里！！这意味着，如果你直接调用getString，主线程会等待加载sp的那么线程加载完毕！这不就把主线程卡住了么？</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">另外，有一个叫诀窍可以节省一下等待的时间：既然getString之类的操作会等待sp加载完成，而加载是在另外一个线程执行的，我们可以让sp先去加载，做一堆事情，然后再getString！如下：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">8</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(142, 144, 140);">// 先让sp去另外一个线程加载</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">SharedPreferences sp = getSharedPreferences(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;test&quot;</span>, MODE_PRIVATE);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(142, 144, 140);">// 做一堆别的事情</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">setContentView(testSpJson);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(142, 144, 140);">// ...</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(142, 144, 140);">// OK,这时候估计已经加载完了吧,就算没完,我们在原本应该等待的时间也做了一些事!</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">String testValue = sp.getString(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;testKey&quot;</span>, <span style="box-sizing:inherit;color:rgb(137, 89, 168);">null</span>);</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">更为严重的是，被加载进来的这些大对象，会永远存在于内存之中，不会被释放。我们看看ContextImpl这个类，在getSharedPreference的时候会把所有的sp放到一个静态变量里面缓存起来：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">8</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">9</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">10</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">11</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">12</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">13</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">14</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">private</span> ArrayMap&lt;File, SharedPreferencesImpl&gt; getSharedPreferencesCacheLocked() {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">if</span> (sSharedPrefsCache == <span style="box-sizing:inherit;color:rgb(137, 89, 168);">null</span>) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        sSharedPrefsCache = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> ArrayMap&lt;&gt;();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">final</span> String packageName = getPackageName();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    ArrayMap&lt;File, SharedPreferencesImpl&gt; packagePrefs = sSharedPrefsCache.get(packageName);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">if</span> (packagePrefs == <span style="box-sizing:inherit;color:rgb(137, 89, 168);">null</span>) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        packagePrefs = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> ArrayMap&lt;&gt;();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        sSharedPrefsCache.put(packageName, packagePrefs);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">return</span> packagePrefs;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">注意这个<strong style="box-sizing:inherit;font-weight:bold;">static</strong>的<code style="box-sizing:inherit;font-size:1em;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;background:rgb(238, 238, 238);text-shadow:rgb(255, 255, 255) 0px 1px;padding:0px 0.3em;">sSharedPrefsCache</code>，它保存了你所有使用的sp，然后sp里面有一个成员<code style="box-sizing:inherit;font-size:1em;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;background:rgb(238, 238, 238);text-shadow:rgb(255, 255, 255) 0px 1px;padding:0px 0.3em;">mMap</code>保存了所有的键值对；这样，你程序中使用到的那些个sp永远就呆在内存中，是不是不寒而栗？！</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">所以，<strong style="box-sizing:inherit;font-weight:bold;">请不要在sp里面存储炒鸡大的key</strong>碰到这样的猪队友，请让他自行检讨！！赶紧把自家App检查一下！！</p>
<h2 style="box-sizing:inherit;margin:20px 0px 10px;padding:0px;font-weight:bold;line-height:1;font-family:Cambria, Georgia, &quot;Microsoft Jhenghei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Times New Roman&quot;, serif;font-size:22px;padding-top:10px;">存储JSON等特殊符号很多的value</h2><p style="box-sizing:inherit;margin:0px 0px 25px;">还有一些童鞋，他在sp里面存json或者HTML；这么做不是不可以，但是，如果这个json相对较大，那么也会引起sp读取速度的急剧下降。</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">JSON或者HTML格式存放在sp里面的时候，需要转义，这样会带来很多<code style="box-sizing:inherit;font-size:1em;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;background:rgb(238, 238, 238);text-shadow:rgb(255, 255, 255) 0px 1px;padding:0px 0.3em;">&amp;</code>这种特殊符号，sp在解析碰到这个特殊符号的时候会进行特殊的处理，引发额外的字符串拼接以及函数调用开销。而JSON本来就是可以用来做配置文件的，你干嘛又把它放在sp里面呢？多此一举。下面我写个demo验证一下。</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">下面这个sp是某个app的换肤配置：</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;"><a href="http://7xp3xc.com1.z0.glb.clouddn.com/201601/1476282570956.png" style="box-sizing:inherit;background-color:transparent;color:rgb(34, 34, 34);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;border-bottom-color:rgb(204, 204, 204);"><img src="请不要滥用SharedPreference_files/1476282570956.png" type="image/png" data-filename="1476282570956.png" height="123" style="max-width:100%;height:auto;cursor:-webkit-zoom-in;border:1px solid rgb(221, 221, 221);box-sizing:border-box;padding:3px;margin:0px auto;display:block;" width="696"/></a></p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">我们先用sp进行读取，然后用直接把它丢json文件，直接读取并且解析；json使用的代码如下：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">8</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">9</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">10</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">11</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">12</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">13</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">14</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">15</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">16</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">17</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">18</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">19</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">20</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">21</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">22</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">23</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">24</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">25</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">26</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">27</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">28</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">public</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">int</span> <span style="box-sizing:inherit;color:rgb(62, 153, 159);">getValueByJson</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">(Context context, String key)</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    File jsonFile = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> File(context.getFilesDir().getParent() + File.separator + SP_DIR_NAME, <span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;skin_beta2.json&quot;</span>);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    FileInputStream fis = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">null</span>;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    ByteArrayOutputStream bao = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> ByteArrayOutputStream();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">try</span> {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        fis = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> FileInputStream(jsonFile);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        FileChannel channel = fis.getChannel();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        ByteBuffer buffer = ByteBuffer.allocate(<span style="box-sizing:inherit;color:rgb(245, 135, 31);">1</span> &lt;&lt; <span style="box-sizing:inherit;color:rgb(245, 135, 31);">13</span>); <span style="box-sizing:inherit;color:rgb(142, 144, 140);">// 8K</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">int</span> i1;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">while</span> ((i1 = channel.read(buffer)) != -<span style="box-sizing:inherit;color:rgb(245, 135, 31);">1</span>) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            buffer.flip();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            bao.write(buffer.array(), <span style="box-sizing:inherit;color:rgb(245, 135, 31);">0</span>, i1);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            buffer.clear();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        String content = bao.toString();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        JSONObject jsonObject = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> JSONObject(content);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">return</span> jsonObject.getInt(key);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    } <span style="box-sizing:inherit;color:rgb(137, 89, 168);">catch</span> (IOException e) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        e.printStackTrace();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    } <span style="box-sizing:inherit;color:rgb(137, 89, 168);">catch</span> (JSONException e) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">throw</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> RuntimeException(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;not a json file&quot;</span>);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    } <span style="box-sizing:inherit;color:rgb(137, 89, 168);">finally</span> {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        close(fis);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        close(bao);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">return</span> <span style="box-sizing:inherit;color:rgb(245, 135, 31);">0</span>;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">然后我的测试结果是：直接解析JSON比在xml里面要快一倍！在小米1S上结果如下：</p>
<table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:100%;border:1px solid rgb(221, 221, 221);">
<thead style="box-sizing:inherit;">
<tr style="box-sizing:inherit;">
<th style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:700;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding-bottom:10px;">时间</th>
<th style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:700;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding-bottom:10px;">json</th>
<th style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:700;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding-bottom:10px;">sp</th>
</tr>
</thead>
<tbody style="box-sizing:inherit;">
<tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);">
<td style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);border-bottom-width:1px;">Mi 1S</td>
<td style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);border-bottom-width:1px;">80</td>
<td style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);border-bottom-width:1px;">38</td>
</tr>
<tr style="box-sizing:inherit;">
<td style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);border-bottom-width:1px;">Nexus5X</td>
<td style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);border-bottom-width:1px;">3.5</td>
<td style="box-sizing:inherit;padding:8px;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);border-bottom-width:1px;">6.5</td>
</tr>
</tbody>
</table>
<p style="box-sizing:inherit;margin:0px 0px 25px;">这个JSON的读取还没有做任何的优化，提升潜力巨大！因此，<strong style="box-sizing:inherit;font-weight:bold;">如果你需要用JSON做配置，请不要把它存放在sp里面！！</strong></p>
<h2 style="box-sizing:inherit;margin:20px 0px 10px;padding:0px;font-weight:bold;line-height:1;font-family:Cambria, Georgia, &quot;Microsoft Jhenghei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Times New Roman&quot;, serif;font-size:22px;padding-top:10px;">多次edit多次apply</h2><p style="box-sizing:inherit;margin:0px 0px 25px;">我见过这样的使用代码：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;">SharedPreferences sp = getSharedPreferences(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;test&quot;</span>, MODE_PRIVATE);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">sp.edit().putString(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;test1&quot;</span>, <span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;sss&quot;</span>).apply();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">sp.edit().putString(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;test2&quot;</span>, <span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;sss&quot;</span>).apply();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">sp.edit().putString(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;test3&quot;</span>, <span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;sss&quot;</span>).apply();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">sp.edit().putString(<span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;test4&quot;</span>, <span style="box-sizing:inherit;color:rgb(113, 140, 0);">&quot;sss&quot;</span>).apply();</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">每次edit都会创建一个Editor对象，额外占用内存；当然多创建几个对象也影响不了多少；但是，多次apply也会卡界面你造吗？</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">有童鞋会说，apply不是在别的线程些磁盘的吗，怎么可能卡界面？我带你仔细看一下源码。</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">8</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">9</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">10</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">11</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">12</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">13</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">14</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">15</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">16</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">17</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">18</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">19</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">20</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">21</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">22</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">23</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">public</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">void</span> <span style="box-sizing:inherit;color:rgb(62, 153, 159);">apply</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">()</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">final</span> MemoryCommitResult mcr = commitToMemory();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">final</span> Runnable awaitCommit = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> Runnable() {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            <span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">public</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">void</span> <span style="box-sizing:inherit;color:rgb(62, 153, 159);">run</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">()</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">                <span style="box-sizing:inherit;color:rgb(137, 89, 168);">try</span> {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">                    mcr.writtenToDiskLatch.await();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">                } <span style="box-sizing:inherit;color:rgb(137, 89, 168);">catch</span> (InterruptedException ignored) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">                }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        };</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    QueuedWork.add(awaitCommit);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    Runnable postWriteRunnable = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> Runnable() {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            <span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">public</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">void</span> <span style="box-sizing:inherit;color:rgb(62, 153, 159);">run</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">()</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">                awaitCommit.run();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">                QueuedWork.remove(awaitCommit);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        };</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    SharedPreferencesImpl.<span style="box-sizing:inherit;color:rgb(137, 89, 168);">this</span>.enqueueDiskWrite(mcr, postWriteRunnable);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    notifyListeners(mcr);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">注意两点，第一，把一个带有await的runnable添加进了<code style="box-sizing:inherit;font-size:1em;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;background:rgb(238, 238, 238);text-shadow:rgb(255, 255, 255) 0px 1px;padding:0px 0.3em;">QueueWork</code>类的一个队列；第二，把这个写入任务通过enqueueDiskWrite丢给了一个<strong style="box-sizing:inherit;font-weight:bold;">只有单个线程</strong>的线程池执行。</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">到这里一切都OK，在子线程里面写入不会卡UI。但是，你去ActivityThread类的handleStopActivity里看一看：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">8</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">9</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">10</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">private</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">void</span> <span style="box-sizing:inherit;color:rgb(62, 153, 159);">handleStopActivity</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">(IBinder token, <span style="box-sizing:inherit;color:rgb(137, 89, 168);">boolean</span> show, <span style="box-sizing:inherit;color:rgb(137, 89, 168);">int</span> configChanges, <span style="box-sizing:inherit;color:rgb(137, 89, 168);">int</span> seq)</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(142, 144, 140);">// 省略无关。。</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(142, 144, 140);">// Make sure any pending writes are now committed.</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">if</span> (!r.isPreHoneycomb()) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        QueuedWork.waitToFinish();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(142, 144, 140);">// 省略无关。。</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">waitToFinish?? 又要等？源码如下：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">public</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">static</span> <span style="box-sizing:inherit;color:rgb(137, 89, 168);">void</span> <span style="box-sizing:inherit;color:rgb(62, 153, 159);">waitToFinish</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">()</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    Runnable toFinish;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">while</span> ((toFinish = sPendingWorkFinishers.poll()) != <span style="box-sizing:inherit;color:rgb(137, 89, 168);">null</span>) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        toFinish.run();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">还记得这个<code style="box-sizing:inherit;font-size:1em;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;background:rgb(238, 238, 238);text-shadow:rgb(255, 255, 255) 0px 1px;padding:0px 0.3em;">toFinish</code>的Runnable是啥吗？就是上面那个<code style="box-sizing:inherit;font-size:1em;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;background:rgb(238, 238, 238);text-shadow:rgb(255, 255, 255) 0px 1px;padding:0px 0.3em;">awaitCommit</code>它里面就一句话，等待写入线程！！如果在Activity Stop的时候，已经写入完毕了，那么万事大吉，不会有任何等待，这个函数会立马返回。但是，如果你使用了太多次的apply，那么意味着写入队列会有很多写入任务，而那里就只有一个线程在写。当App规模很大的时候，这种情况简直就太常见了！</p>
<p style="box-sizing:inherit;margin:0px 0px 25px;">因此，虽然apply是在子线程执行的，但是请不要无节制地apply；commit我就不多说了吧？直接在当前线程写入，如果你在主线程干这个，小心挨揍。</p>
<h2 style="box-sizing:inherit;margin:20px 0px 10px;padding:0px;font-weight:bold;line-height:1;font-family:Cambria, Georgia, &quot;Microsoft Jhenghei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Times New Roman&quot;, serif;font-size:22px;padding-top:10px;">用来跨进程</h2><p style="box-sizing:inherit;margin:0px 0px 25px;">还有童鞋发现sp有一个貌似可以提供「跨进程」功能的FLAG——<code style="box-sizing:inherit;font-size:1em;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;background:rgb(238, 238, 238);text-shadow:rgb(255, 255, 255) 0px 1px;padding:0px 0.3em;">MODE_MULTI_PROCESS</code>,我们看看这个FLAG的文档：</p>
<blockquote style="box-sizing:inherit;margin:0px;padding:0px 15px;color:rgb(102, 102, 102);border-left:4px solid rgb(221, 221, 221);">
<p style="box-sizing:inherit;margin:0px 0px 25px;">@deprecated MODE_MULTI_PROCESS does not work reliably in<br style="box-sizing:inherit;"/>some versions of Android, and furthermore does not provide any mechanism for reconciling concurrent modifications across processes.  Applications should not attempt to use it.  Instead, they should use an explicit cross-process data management approach such as {@link android.content.ContentProvider ContentProvider}.</p>
</blockquote>
<p style="box-sizing:inherit;margin:0px 0px 25px;">文档也说了，这玩意在某些Android版本上不可靠，并且未来也不会提供任何支持，要是用跨进程数据传输需要使用类似ContentProvider的东西。而且，SharedPreference的文档也特别说明：</p>
<blockquote style="box-sizing:inherit;margin:0px;padding:0px 15px;color:rgb(102, 102, 102);border-left:4px solid rgb(221, 221, 221);">
<p style="box-sizing:inherit;margin:0px 0px 25px;">Note: This class does not support use across multiple processes.</p>
</blockquote>
<p style="box-sizing:inherit;margin:0px 0px 25px;">那么我们姑且看一看，设置了这个Flag到底干了啥；在SharedPreferenceImpl里面，没有发现任何对这个Flag的使用；然后我们去ContextImpl类里面找找getSharedPreference的时候做了什么：</p>
<div style="box-sizing:inherit;display:block;margin:20px 0px;background:rgb(247, 247, 247);padding:15px;overflow:auto;font-size:13px;color:rgb(77, 77, 76);line-height:1.6;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;box-sizing:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;width:auto;border:none;margin:0px;"><tbody style="box-sizing:inherit;"><tr style="box-sizing:inherit;background-color:rgb(249, 249, 249);"><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="color:rgb(102, 102, 102);box-sizing:inherit;font-size:13px;background:rgb(247, 247, 247);font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;line-height:1.6;overflow:auto;margin:0px;padding:0px;border:none;text-align:right;padding-right:20px;"><span style="box-sizing:inherit;height:20px;">1</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">2</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">3</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">4</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">5</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">6</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">7</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">8</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">9</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">10</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">11</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">12</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">13</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">14</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">15</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">16</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">17</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">18</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">19</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">20</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">21</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">22</span><br style="box-sizing:inherit;"/></pre></td><td style="box-sizing:inherit;text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="box-sizing:inherit;overflow:auto;font-family:&quot;PT Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size:13px;background:rgb(247, 247, 247);color:rgb(77, 77, 76);line-height:1.6;margin:0px;padding:0px;border:none;"><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;">@Override</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;"><span style="box-sizing:inherit;color:rgb(66, 113, 174);"><span style="box-sizing:inherit;color:rgb(137, 89, 168);">public</span> SharedPreferences <span style="box-sizing:inherit;color:rgb(62, 153, 159);">getSharedPreferences</span><span style="box-sizing:inherit;color:rgb(245, 135, 31);">(File file, <span style="box-sizing:inherit;color:rgb(137, 89, 168);">int</span> mode)</span> </span>{</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    checkMode(mode);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    SharedPreferencesImpl sp;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">synchronized</span> (ContextImpl.class) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">final</span> ArrayMap&lt;File, SharedPreferencesImpl&gt; cache = getSharedPreferencesCacheLocked();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        sp = cache.get(file);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(137, 89, 168);">if</span> (sp == <span style="box-sizing:inherit;color:rgb(137, 89, 168);">null</span>) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            sp = <span style="box-sizing:inherit;color:rgb(137, 89, 168);">new</span> SharedPreferencesImpl(file, mode);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            cache.put(file, sp);</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">            <span style="box-sizing:inherit;color:rgb(137, 89, 168);">return</span> sp;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">if</span> ((mode &amp; Context.MODE_MULTI_PROCESS) != <span style="box-sizing:inherit;color:rgb(245, 135, 31);">0</span> ||</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) {</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(142, 144, 140);">// If somebody else (some other process) changed the prefs</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(142, 144, 140);">// file behind our back, we reload it.  This has been the</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        <span style="box-sizing:inherit;color:rgb(142, 144, 140);">// historical (if undocumented) behavior.</span></span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">        sp.startReloadIfChangedUnexpectedly();</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    }</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">    <span style="box-sizing:inherit;color:rgb(137, 89, 168);">return</span> sp;</span><br style="box-sizing:inherit;"/><span style="box-sizing:inherit;height:20px;">}</span><br style="box-sizing:inherit;"/></pre></td></tr></tbody></table></div>
<p style="box-sizing:inherit;margin:0px 0px 25px;">这个flag保证了啥？保证了<strong style="box-sizing:inherit;font-weight:bold;">在API 11以前</strong>的系统上，如果sp已经被读取进内存，再次获取这个sp的时候，如果有这个flag，会重新读一遍文件，仅此而已！所以，如果仰仗这个Flag做跨进程存取，简直就是丢人现眼。</p>
<h2 style="box-sizing:inherit;margin:20px 0px 10px;padding:0px;font-weight:bold;line-height:1;font-family:Cambria, Georgia, &quot;Microsoft Jhenghei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Times New Roman&quot;, serif;font-size:22px;padding-top:10px;">小结</h2><p style="box-sizing:inherit;margin:0px 0px 25px;">总价一下，sp是一种轻量级的存储方式，使用方便，但是也有它适用的场景。要优雅滴使用sp，要注意以下几点：</p>
<ol style="box-sizing:inherit;">
<li style="box-sizing:inherit;">不要存放大的key和value！我就不重复三遍了，会引起界面卡、频繁GC、占用内存等等，好自为之！</li>
<li style="box-sizing:inherit;">毫不相关的配置项就不要丢在一起了！文件越大读取越慢，不知不觉就被猪队友给坑了；蓝后，放进defalut的那个简直就是愚蠢行为！</li>
<li style="box-sizing:inherit;">读取频繁的key和不易变动的key尽量不要放在一起，影响速度。（如果整个文件很小，那么忽略吧，为了这点性能添加维护成本得不偿失）</li>
<li style="box-sizing:inherit;">不要乱edit和apply，尽量批量修改一次提交！</li>
<li style="box-sizing:inherit;">尽量不要存放JSON和HTML，这种场景请直接使用json！</li>
<li style="box-sizing:inherit;">不要指望用这货进行跨进程通信！！！ </li>
</ol>
</span>
      
    </div>

    <div style="box-sizing:inherit;display:block;">
      
        <div style="box-sizing:inherit;margin-top:40px;text-align:left;">
          
            <a href="http://weishu.me/tags/android/" rel="tag" style="box-sizing:inherit;color:rgb(34, 34, 34);text-decoration:none;word-wrap:break-word;border-bottom:none;display:inline-block;margin-right:10px;font-size:13px;padding:1px 5px;background:rgb(245, 245, 245);">#-android</a>
          
        </div>
      

      
        <div style="box-sizing:inherit;overflow:hidden;padding:10px;white-space:nowrap;border-top:1px solid rgb(238, 238, 238);margin-top:40px;">
          <div style="box-sizing:inherit;display:inline-block;width:50%;white-space:normal;">
            
              <a href="http://weishu.me/2016/12/23/dive-into-android-optimize-vm-heap/" rel="prev" style="position:relative;box-sizing:inherit;text-decoration:none;word-wrap:break-word;border-bottom-color:rgb(204, 204, 204);background-color:transparent;border-bottom:none;color:rgb(85, 85, 85);display:inline-block;line-height:25px;font-size:14px;"><span style="color:rgb(85, 85, 85);line-height:25px;font-size:14px;display:inline-block;width:16px;height:25px;vertical-align:top;opacity:0.4;background-size:16px;background:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSIxMnB4IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA5IDEyIiB3aWR0aD0iOXB4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PHRpdGxlLz48ZGVzYy8+PGRlZnMvPjxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCIgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiPjxnIGZpbGw9IiMwMDAwMDAiIGlkPSJDb3JlIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjE4LjAwMDAwMCwgLTkwLjAwMDAwMCkiPjxnIGlkPSJjaGV2cm9uLWxlZnQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIxOC41MDAwMDAsIDkwLjAwMDAwMCkiPjxwYXRoIGQ9Ik03LjQsMS40IEw2LDAgTC04Ljg4MTc4NDJlLTE2LDYgTDYsMTIgTDcuNCwxMC42IEwyLjgsNiBMNy40LDEuNCBaIiBpZD0iU2hhcGUiLz48L2c+PC9nPjwvZz48L3N2Zz4=&quot;) 0px 50% / 8px no-repeat;"> </span>Android性能优化之虚拟机调优<span style="color:rgb(85, 85, 85);line-height:25px;font-size:14px;display:inline-block;width:16px;height:25px;vertical-align:top;opacity:0.4;background-size:16px;"></span></a>
            
          </div>

          <div style="box-sizing:inherit;display:inline-block;width:50%;white-space:normal;text-align:right;">
            
              <a href="http://weishu.me/2016/07/12/understand-plugin-framework-content-provider/" rel="next" style="position:relative;box-sizing:inherit;text-decoration:none;word-wrap:break-word;border-bottom-color:rgb(204, 204, 204);background-color:transparent;border-bottom:none;color:rgb(85, 85, 85);display:inline-block;line-height:25px;font-size:14px;"><span style="color:rgb(85, 85, 85);line-height:25px;font-size:14px;display:inline-block;width:16px;height:25px;vertical-align:top;opacity:0.4;background-size:16px;"></span>Android插件化原理解析——ContentProvider的插件化<span style="color:rgb(85, 85, 85);line-height:25px;font-size:14px;display:inline-block;width:16px;height:25px;vertical-align:top;opacity:0.4;background-size:16px;background:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSIxMnB4IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA5IDEyIiB3aWR0aD0iOXB4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PHRpdGxlLz48ZGVzYy8+PGRlZnMvPjxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCIgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiPjxnIGZpbGw9IiMwMDAwMDAiIGlkPSJDb3JlIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjYwLjAwMDAwMCwgLTkwLjAwMDAwMCkiPjxnIGlkPSJjaGV2cm9uLXJpZ2h0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNjAuNTAwMDAwLCA5MC4wMDAwMDApIj48cGF0aCBkPSJNMSwwIEwtMC40LDEuNCBMNC4yLDYgTC0wLjQsMTAuNiBMMSwxMiBMNyw2IEwxLDAgWiIgaWQ9IlNoYXBlIi8+PC9nPjwvZz48L2c+PC9zdmc+&quot;) 100% 50% / 8px no-repeat;"> </span></a>
            
          </div>
        </div>
      

      
      
    </div>
  </div></div></div></div></span></div></div></div></div><br/></div></span>
</div></body></html> 