<html>
<head>
  <title>CLASSLOADER的工作机制</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/10.0.15063 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3056"/>
<h1>CLASSLOADER的工作机制</h1>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="font-family:sans-serif;text-size-adjust:100%;"><div style="font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;line-height:2;color:rgb(85, 85, 85);background:rgb(255, 255, 255);"><div><span><div><div><div><div><div style="opacity:1;transform:translateY(0px);">
  

  

  

    
      <div style="display:block;">

        
        
          <h1 style="margin:0px;padding:0px;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:26px;font-weight:400;text-align:center;word-break:break-word;">
            
            
              
                CLASSLOADER的工作机制
              
            
          </h1>
        

        <div style="margin:3px 0px 60px;color:rgb(153, 153, 153);font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:12px;text-align:center;">
          <span>
            
            <span>Posted on</span>
            <span title="Post created">
              2016-02-07
            </span>

             | 

            
            <span title="Post modified">
              2017-09-12
            </span>
            
          </span>

          
            <span>
                |  
              
              <span>In</span>
              
                <span>
                  <a href="http://kaedea.com/categories/Android/" rel="index" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;">
                    <span>Android</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span>
                  <a href="http://kaedea.com/categories/Android/%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/" rel="index" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;">
                    <span>动态加载</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span>
                  |  
                <a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#comments" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;">
                  <span></span>
                </a>
              </span>
            
          

          

          
          
             <span>
                 |  
               
               <span>Visitors </span>
               <span>898</span>
              </span>
          

          
          
          

        </div>
      </div>
    


    <div style="font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;">

      
      

      
        <p style="margin:0px 0px 25px;">早期使用过Eclipse等Java编写的软件的同学可能比较熟悉，Eclipse可以加载许多第三方的插件（或者叫扩展），这就是动态加载。这些插件大多是一些Jar包，而使用插件其实就是动态加载Jar包里的Class进行工作。这其实非常好理解，Java代码都是写在Class里面的，程序运行在虚拟机上时，虚拟机需要把需要的Class加载进来才能创建实例对象并工作，而完成这一个加载工作的角色就是ClassLoader。<br/><a style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;"></a></p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="基本信息"></a>基本信息</h2><ul style="list-style:none;">
<li style="list-style:circle;">Author : <a href="https://github.com/kaedea" rel="external" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" target="_blank">Kaede</a></li>
<li style="list-style:circle;">Index : <a href="http://kaedea.com/2016/02/05/android-dynamical-loading-00-index" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;">ANDROID动态加载系列</a></li>
<li style="list-style:circle;">GitHub : <a href="https://github.com/kaedea/android-dynamical-loading" rel="external" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" target="_blank">kaedea/android-dynamical-loading</a></li>
</ul>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8ClassLoader" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="类加载器ClassLoader"></a>类加载器ClassLoader</h2><blockquote style="margin:0px;padding:0px 15px;color:rgb(102, 102, 102);border-left:4px solid rgb(221, 221, 221);">
<p style="margin:0px 0px 25px;">对于Java程序来说，编写程序就是编写类，运行程序也就是运行类（编译得到的<code style="font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;font-size:13px;padding:2px 4px;word-wrap:break-word;color:rgb(204, 204, 204);background:rgb(45, 45, 45);border-radius:3px;">class文件</code>），其中起到关键作用的就是类加载器ClassLoader。</p>
</blockquote>
<p style="margin:0px 0px 25px;">Android的Dalvik/ART虚拟机如同标准JAVA的JVM虚拟机一样，在运行程序时首先需要将对应的类加载到内存中。因此，我们可以利用这一点，在程序运行时手动加载Class，从而达到代码动态加载可执行文件的目的。Android的Dalvik/ART虚拟机虽然与标准Java的JVM虚拟机不一样，ClassLoader具体的加载细节不一样，但是工作机制是类似的，也就是说在Android中同样可以采用类似的动态加载插件的功能，只是在Android应用中动态加载一个插件的工作要比Eclipse加载一个插件复杂许多（这点后面在解释说明）。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E6%9C%89%E5%87%A0%E4%B8%AAClassLoader%E5%AE%9E%E4%BE%8B%EF%BC%9F" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="有几个ClassLoader实例？"></a>有几个ClassLoader实例？</h2><p style="margin:0px 0px 25px;"><strong style="font-weight:bold;">动态加载的基础是ClassLoader</strong>，从名字也可以看出，ClassLoader就是专门用来处理类加载工作的，所以这货也叫类加载器，而且一个运行中的APP <strong style="font-weight:bold;">不仅只有一个类加载器</strong>。</p>
<p style="margin:0px 0px 25px;">其实，在Android系统启动的时候会创建一个Boot类型的ClassLoader实例，用于加载一些系统Framework层级需要的类，我们的Android应用里也需要用到一些系统的类，所以APP启动的时候也会把这个Boot类型的ClassLoader传进来。</p>
<p style="margin:0px 0px 25px;">此外，APP也有自己的类，这些类保存在APK的dex文件里面，所以APP启动的时候，也会创建一个自己的ClassLoader实例，用于加载自己dex文件中的类。下面我们在项目里验证看看<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;">   <span style="color:rgb(204, 153, 204);">@Override</span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">protected</span> <span style="color:rgb(204, 153, 204);">void</span> <span style="color:rgb(102, 204, 204);">onCreate</span><span style="color:rgb(249, 145, 87);">(Bundle savedInstanceState)</span> </span>{</div><div style="height:20px;">	<span style="color:rgb(204, 153, 204);">super</span>.onCreate(savedInstanceState);</div><div style="height:20px;">	ClassLoader classLoader = getClassLoader();</div><div style="height:20px;">	<span style="color:rgb(204, 153, 204);">if</span> (classLoader != <span style="color:rgb(204, 153, 204);">null</span>){</div><div style="height:20px;">		Log.i(TAG, <span style="color:rgb(153, 204, 153);">&quot;[onCreate] classLoader &quot;</span> + i + <span style="color:rgb(153, 204, 153);">&quot; : &quot;</span> + classLoader.toString());</div><div style="height:20px;">		<span style="color:rgb(204, 153, 204);">while</span> (classLoader.getParent()!=<span style="color:rgb(204, 153, 204);">null</span>){</div><div style="height:20px;">			classLoader = classLoader.getParent();</div><div style="height:20px;">			Log.i(TAG,<span style="color:rgb(153, 204, 153);">&quot;[onCreate] classLoader &quot;</span> + i + <span style="color:rgb(153, 204, 153);">&quot; : &quot;</span> + classLoader.toString());</div><div style="height:20px;">		}</div><div style="height:20px;">	}</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">输出结果为<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;">[onCreate] classLoader 1 : dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/data/app/me.kaede.anroidclassloadersample-1/base.apk&quot;],nativeLibraryDirectories=[/vendor/lib, /system/lib]]]</div><div style="height:20px;"></div><div style="height:20px;">[onCreate] classLoader 2 : java.lang.BootClassLoader@14af4e32</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">可以看见有2个Classloader实例，一个是BootClassLoader（系统启动的时候创建的），另一个是PathClassLoader（应用启动时创建的，用于加载“/data/app/me.kaede.anroidclassloadersample-1/base.apk”里面的类）。由此也可以看出，<strong style="font-weight:bold;">一个运行的Android应用至少有2个ClassLoader</strong>。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1ClassLoader%E5%AE%9E%E4%BE%8B" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="创建自己ClassLoader实例"></a>创建自己ClassLoader实例</h2><p style="margin:0px 0px 25px;">动态加载外部的dex文件的时候，我们也可以使用自己创建的ClassLoader实例来加载dex里面的Class，不过ClassLoader的创建方式有点特殊，我们先看看它的构造方法<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(153, 153, 153);">/*</span></div><div style="height:20px;"><span style="color:rgb(153, 153, 153);"> * constructor for the BootClassLoader which needs parent to be null.</span></div><div style="height:20px;"><span style="color:rgb(153, 153, 153);"> */</span></div><div style="height:20px;">ClassLoader(ClassLoader parentLoader, <span style="color:rgb(204, 153, 204);">boolean</span> nullAllowed) {</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">if</span> (parentLoader == <span style="color:rgb(204, 153, 204);">null</span> &amp;&amp; !nullAllowed) {</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">throw</span> <span style="color:rgb(204, 153, 204);">new</span> NullPointerException(<span style="color:rgb(153, 204, 153);">&quot;parentLoader == null &amp;&amp; !nullAllowed&quot;</span>);</div><div style="height:20px;">    }</div><div style="height:20px;">    parent = parentLoader;</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">创建一个ClassLoader实例的时候，需要使用一个现有的ClassLoader实例作为新创建的实例的Parent。这样一来，一个Android应用，甚至整个Android系统里所有的ClassLoader实例都会被一棵树关联起来，这也是ClassLoader的 <strong style="font-weight:bold;">双亲代理模型</strong>（Parent-Delegation Model）的特点。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#ClassLoader%E5%8F%8C%E4%BA%B2%E4%BB%A3%E7%90%86%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E7%B1%BB%E7%9A%84%E7%89%B9%E7%82%B9%E5%92%8C%E4%BD%9C%E7%94%A8" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="ClassLoader双亲代理模型加载类的特点和作用"></a>ClassLoader双亲代理模型加载类的特点和作用</h2><p style="margin:0px 0px 25px;">JVM中ClassLoader通过defineClass方法加载jar里面的Class，而Android中这个方法被弃用了。<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(204, 153, 204);">@Deprecated</span></div><div style="height:20px;"><span style="color:rgb(204, 153, 204);">protected</span> <span style="color:rgb(204, 153, 204);">final</span> Class&lt;?&gt; defineClass(<span style="color:rgb(204, 153, 204);">byte</span>[] classRep, <span style="color:rgb(204, 153, 204);">int</span> offset, <span style="color:rgb(204, 153, 204);">int</span> length)</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">throws</span> ClassFormatError {</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">throw</span> <span style="color:rgb(204, 153, 204);">new</span> UnsupportedOperationException(<span style="color:rgb(153, 204, 153);">&quot;can't load this type of class file&quot;</span>);</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">取而代之的是loadClass方法<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(204, 153, 204);">public</span> Class&lt;?&gt; loadClass(String className) <span style="color:rgb(204, 153, 204);">throws</span> ClassNotFoundException {</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">return</span> loadClass(className, <span style="color:rgb(204, 153, 204);">false</span>);</div><div style="height:20px;">}</div><div style="height:20px;"></div><div style="height:20px;"><span style="color:rgb(204, 153, 204);">protected</span> Class&lt;?&gt; loadClass(String className, <span style="color:rgb(204, 153, 204);">boolean</span> resolve) <span style="color:rgb(204, 153, 204);">throws</span> ClassNotFoundException {</div><div style="height:20px;">    Class&lt;?&gt; clazz = findLoadedClass(className);</div><div style="height:20px;"></div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">if</span> (clazz == <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">        ClassNotFoundException suppressed = <span style="color:rgb(204, 153, 204);">null</span>;</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">try</span> {</div><div style="height:20px;">            clazz = parent.loadClass(className, <span style="color:rgb(204, 153, 204);">false</span>);</div><div style="height:20px;">        } <span style="color:rgb(204, 153, 204);">catch</span> (ClassNotFoundException e) {</div><div style="height:20px;">            suppressed = e;</div><div style="height:20px;">        }</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">if</span> (clazz == <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">            <span style="color:rgb(204, 153, 204);">try</span> {</div><div style="height:20px;">                clazz = findClass(className);</div><div style="height:20px;">            } <span style="color:rgb(204, 153, 204);">catch</span> (ClassNotFoundException e) {</div><div style="height:20px;">                e.addSuppressed(suppressed);</div><div style="height:20px;">                <span style="color:rgb(204, 153, 204);">throw</span> e;</div><div style="height:20px;">            }</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;"></div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">return</span> clazz;</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<h3 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E7%89%B9%E7%82%B9" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="特点"></a>特点</h3><p style="margin:0px 0px 25px;">从源码中我们也可以看出，loadClass方法在加载一个类的实例的时候，</p>
<ol>
<li>会先查询当前ClassLoader实例是否加载过此类，有就返回；</li>
<li>如果没有。查询Parent是否已经加载过此类，如果已经加载过，就直接返回Parent加载的类；</li>
<li>如果继承路线上的ClassLoader都没有加载，才由Child执行类的加载工作；</li>
</ol>
<p style="margin:0px 0px 25px;">这样做有个明显的特点，如果一个类被位于树根的ClassLoader加载过，那么在以后整个系统的生命周期内，这个类永远不会被重新加载。</p>
<h3 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E4%BD%9C%E7%94%A8" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="作用"></a>作用</h3><p style="margin:0px 0px 25px;">首先是共享功能，一些Framework层级的类一旦被顶层的ClassLoader加载过就缓存在内存里面，以后任何地方用到都不需要重新加载。</p>
<p style="margin:0px 0px 25px;">除此之外还有隔离功能，不同继承路线上的ClassLoader加载的类肯定不是同一个类，这样的限制避免了用户自己的代码冒充核心类库的类访问核心类库包可见成员的情况。这也好理解，一些系统层级的类会在系统初始化的时候被加载，比如java.lang.String，如果在一个应用里面能够简单地用自定义的String类把这个系统的String类给替换掉，那将会有严重的安全问题。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E4%BD%BF%E7%94%A8ClassLoader%E4%B8%80%E4%BA%9B%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="使用ClassLoader一些需要注意的问题"></a>使用ClassLoader一些需要注意的问题</h2><p style="margin:0px 0px 25px;">我们都知道，我们可以通过动态加载获得新的类，从而升级一些代码逻辑，这里有几个问题要注意一下。</p>
<p style="margin:0px 0px 25px;">如果你希望通过动态加载的方式，加载一个新版本的dex文件，使用里面的新类替换原有的旧类，从而修复原有类的BUG，那么你必须保证在加载新类的时候，旧类还没有被加载，因为如果已经加载过旧类，那么ClassLoader会一直优先使用旧类。</p>
<p style="margin:0px 0px 25px;">如果旧类总是优先于新类被加载，我们也可以使用一个与加载旧类的ClassLoader没有树的继承关系的另一个ClassLoader来加载新类，因为ClassLoader只会检查其Parent有没有加载过当前要加载的类，如果两个ClassLoader没有继承关系，那么旧类和新类都能被加载。</p>
<p style="margin:0px 0px 25px;">不过这样一来又有另一个问题了，在Java中，只有当两个实例的类名、包名以及加载其的ClassLoader都相同，才会被认为是同一种类型。上面分别加载的新类和旧类，虽然包名和类名都完全一样，但是由于加载的ClassLoader不同，所以并不是同一种类型，在实际使用中可能会出现类型不符异常。</p>
<blockquote style="margin:0px;padding:0px 15px;color:rgb(102, 102, 102);border-left:4px solid rgb(221, 221, 221);">
<p style="margin:0px 0px 25px;">同一个Class = 相同的 ClassName + PackageName + ClassLoader</p>
</blockquote>
<p style="margin:0px 0px 25px;">以上问题在采用动态加载功能的开发中容易出现，请注意。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#DexClassLoader-%E5%92%8C-PathClassLoader" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="DexClassLoader 和 PathClassLoader"></a>DexClassLoader 和 PathClassLoader</h2><p style="margin:0px 0px 25px;">在Android中，ClassLoader是一个抽象类，实际开发过程中，我们一般是使用其具体的子类DexClassLoader、PathClassLoader这些类加载器来加载类的，它们的不同之处是：</p>
<ul style="list-style:none;">
<li style="list-style:circle;">DexClassLoader可以加载jar/apk/dex，可以从SD卡中加载未安装的apk；</li>
<li style="list-style:circle;">PathClassLoader只能加载系统中已经安装过的apk；</li>
</ul>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="类加载器的初始化"></a>类加载器的初始化</h2><p style="margin:0px 0px 25px;">平时开发的时候，使用DexClassLoader就够用了，但是我们不妨挖一下这两者具体细节上的区别。<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(153, 153, 153);">// DexClassLoader.java</span></div><div style="height:20px;"><span style="color:rgb(204, 153, 204);">public</span> <span><span style="color:rgb(204, 153, 204);">class</span> <span style="color:rgb(102, 204, 204);">DexClassLoader</span> <span style="color:rgb(204, 153, 204);">extends</span> <span style="color:rgb(102, 204, 204);">BaseDexClassLoader</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">public</span> <span style="color:rgb(102, 204, 204);">DexClassLoader</span><span style="color:rgb(249, 145, 87);">(String dexPath, String optimizedDirectory,</span></span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(249, 145, 87);">            String libraryPath, ClassLoader parent)</span> </span>{</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">super</span>(dexPath, <span style="color:rgb(204, 153, 204);">new</span> File(optimizedDirectory), libraryPath, parent);</div><div style="height:20px;">    }</div><div style="height:20px;">}</div><div style="height:20px;"></div><div style="height:20px;"><span style="color:rgb(153, 153, 153);">// PathClassLoader.java</span></div><div style="height:20px;"><span style="color:rgb(204, 153, 204);">public</span> <span><span style="color:rgb(204, 153, 204);">class</span> <span style="color:rgb(102, 204, 204);">PathClassLoader</span> <span style="color:rgb(204, 153, 204);">extends</span> <span style="color:rgb(102, 204, 204);">BaseDexClassLoader</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">public</span> <span style="color:rgb(102, 204, 204);">PathClassLoader</span><span style="color:rgb(249, 145, 87);">(String dexPath, ClassLoader parent)</span> </span>{</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">super</span>(dexPath, <span style="color:rgb(204, 153, 204);">null</span>, <span style="color:rgb(204, 153, 204);">null</span>, parent);</div><div style="height:20px;">    }</div><div style="height:20px;"></div><div style="height:20px;">    <span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">public</span> <span style="color:rgb(102, 204, 204);">PathClassLoader</span><span style="color:rgb(249, 145, 87);">(String dexPath, String libraryPath,</span></span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(249, 145, 87);">            ClassLoader parent)</span> </span>{</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">super</span>(dexPath, <span style="color:rgb(204, 153, 204);">null</span>, libraryPath, parent);</div><div style="height:20px;">    }</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">这两者只是简单的对BaseDexClassLoader做了一下封装，具体的实现还是在父类里。不过这里也可以看出，PathClassLoader的optimizedDirectory只能是null，进去BaseDexClassLoader看看这个参数是干什么的<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">public</span> <span style="color:rgb(102, 204, 204);">BaseDexClassLoader</span><span style="color:rgb(249, 145, 87);">(String dexPath, File optimizedDirectory,</span></span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(249, 145, 87);">            String libraryPath, ClassLoader parent)</span> </span>{</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">super</span>(parent);</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">this</span>.originalPath = dexPath;</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">this</span>.pathList = <span style="color:rgb(204, 153, 204);">new</span> DexPathList(<span style="color:rgb(204, 153, 204);">this</span>, dexPath, libraryPath, optimizedDirectory);</div><div style="height:20px;">    }</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">这里创建了一个DexPathList实例，进去看看<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div><div style="height:20px;">31</div><div style="height:20px;">32</div><div style="height:20px;">33</div><div style="height:20px;">34</div><div style="height:20px;">35</div><div style="height:20px;">36</div><div style="height:20px;">37</div><div style="height:20px;">38</div><div style="height:20px;">39</div><div style="height:20px;">40</div><div style="height:20px;">41</div><div style="height:20px;">42</div><div style="height:20px;">43</div><div style="height:20px;">44</div><div style="height:20px;">45</div><div style="height:20px;">46</div><div style="height:20px;">47</div><div style="height:20px;">48</div><div style="height:20px;">49</div><div style="height:20px;">50</div><div style="height:20px;">51</div><div style="height:20px;">52</div><div style="height:20px;">53</div><div style="height:20px;">54</div><div style="height:20px;">55</div><div style="height:20px;">56</div><div style="height:20px;">57</div><div style="height:20px;">58</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">public</span> <span style="color:rgb(102, 204, 204);">DexPathList</span><span style="color:rgb(249, 145, 87);">(ClassLoader definingContext, String dexPath,</span></span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(249, 145, 87);">        String libraryPath, File optimizedDirectory)</span> </span>{</div><div style="height:20px;">    ……</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">this</span>.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory);</div><div style="height:20px;">}</div><div style="height:20px;"></div><div style="height:20px;"><span style="color:rgb(204, 153, 204);">private</span> <span style="color:rgb(204, 153, 204);">static</span> Element[] makeDexElements(ArrayList&lt;File&gt; files,</div><div style="height:20px;">        File optimizedDirectory) {</div><div style="height:20px;">    ArrayList&lt;Element&gt; elements = <span style="color:rgb(204, 153, 204);">new</span> ArrayList&lt;Element&gt;();</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">for</span> (File file : files) {</div><div style="height:20px;">        ZipFile zip = <span style="color:rgb(204, 153, 204);">null</span>;</div><div style="height:20px;">        DexFile dex = <span style="color:rgb(204, 153, 204);">null</span>;</div><div style="height:20px;">        String name = file.getName();</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">if</span> (name.endsWith(DEX_SUFFIX)) {</div><div style="height:20px;">            dex = loadDexFile(file, optimizedDirectory);</div><div style="height:20px;">        } <span style="color:rgb(204, 153, 204);">else</span> <span style="color:rgb(204, 153, 204);">if</span> (name.endsWith(APK_SUFFIX) || name.endsWith(JAR_SUFFIX)</div><div style="height:20px;">                || name.endsWith(ZIP_SUFFIX)) {</div><div style="height:20px;">            zip = <span style="color:rgb(204, 153, 204);">new</span> ZipFile(file);</div><div style="height:20px;">        }</div><div style="height:20px;">        ……</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">if</span> ((zip != <span style="color:rgb(204, 153, 204);">null</span>) || (dex != <span style="color:rgb(204, 153, 204);">null</span>)) {</div><div style="height:20px;">            elements.add(<span style="color:rgb(204, 153, 204);">new</span> Element(file, zip, dex));</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">return</span> elements.toArray(<span style="color:rgb(204, 153, 204);">new</span> Element[elements.size()]);</div><div style="height:20px;">}</div><div style="height:20px;"></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">private</span> <span style="color:rgb(204, 153, 204);">static</span> DexFile <span style="color:rgb(102, 204, 204);">loadDexFile</span><span style="color:rgb(249, 145, 87);">(File file, File optimizedDirectory)</span></span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);">        <span style="color:rgb(204, 153, 204);">throws</span> IOException </span>{</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">if</span> (optimizedDirectory == <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">return</span> <span style="color:rgb(204, 153, 204);">new</span> DexFile(file);</div><div style="height:20px;">    } <span style="color:rgb(204, 153, 204);">else</span> {</div><div style="height:20px;">        String optimizedPath = optimizedPathFor(file, optimizedDirectory);</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">return</span> DexFile.loadDex(file.getPath(), optimizedPath, <span style="color:rgb(153, 204, 153);">0</span>);</div><div style="height:20px;">    }</div><div style="height:20px;">}</div><div style="height:20px;"></div><div style="height:20px;"><span style="color:rgb(153, 153, 153);">/**</span></div><div style="height:20px;"><span style="color:rgb(153, 153, 153);"> * Converts a dex/jar file path and an output directory to an</span></div><div style="height:20px;"><span style="color:rgb(153, 153, 153);"> * output file path for an associated optimized dex file.</span></div><div style="height:20px;"><span style="color:rgb(153, 153, 153);"> */</span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">private</span> <span style="color:rgb(204, 153, 204);">static</span> String <span style="color:rgb(102, 204, 204);">optimizedPathFor</span><span style="color:rgb(249, 145, 87);">(File path,</span></span></div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(249, 145, 87);">        File optimizedDirectory)</span> </span>{</div><div style="height:20px;">    String fileName = path.getName();</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">if</span> (!fileName.endsWith(DEX_SUFFIX)) {</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">int</span> lastDot = fileName.lastIndexOf(<span style="color:rgb(153, 204, 153);">&quot;.&quot;</span>);</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">if</span> (lastDot &lt; <span style="color:rgb(153, 204, 153);">0</span>) {</div><div style="height:20px;">            fileName += DEX_SUFFIX;</div><div style="height:20px;">        } <span style="color:rgb(204, 153, 204);">else</span> {</div><div style="height:20px;">            StringBuilder sb = <span style="color:rgb(204, 153, 204);">new</span> StringBuilder(lastDot + <span style="color:rgb(153, 204, 153);">4</span>);</div><div style="height:20px;">            sb.append(fileName, <span style="color:rgb(153, 204, 153);">0</span>, lastDot);</div><div style="height:20px;">            sb.append(DEX_SUFFIX);</div><div style="height:20px;">            fileName = sb.toString();</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;">    File result = <span style="color:rgb(204, 153, 204);">new</span> File(optimizedDirectory, fileName);</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">return</span> result.getPath();</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">看到这里我们明白了，optimizedDirectory是用来缓存我们需要加载的dex文件的，并创建一个DexFile对象，如果它为null，那么会直接使用dex文件原有的路径来创建DexFile<br/>对象。</p>
<p style="margin:0px 0px 25px;">optimizedDirectory必须是一个内部存储路径，还记得我们之前说过的，无论哪种动态加载，加载的可执行文件一定要存放在内部存储。DexClassLoader可以指定自己的optimizedDirectory，所以它可以加载外部的dex，因为这个dex会被复制到内部路径的optimizedDirectory；而PathClassLoader没有optimizedDirectory，所以它只能加载内部的dex，这些大都是存在系统中已经安装过的apk里面的。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E5%8A%A0%E8%BD%BD%E7%B1%BB%E7%9A%84%E8%BF%87%E7%A8%8B" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="加载类的过程"></a>加载类的过程</h2><p style="margin:0px 0px 25px;">上面还只是创建了类加载器的实例，其中创建了一个DexFile实例，用来保存dex文件，我们猜想这个实例就是用来加载类的。</p>
<p style="margin:0px 0px 25px;">Android中，ClassLoader用loadClass方法来加载我们需要的类<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(204, 153, 204);">public</span> Class&lt;?&gt; loadClass(String className) <span style="color:rgb(204, 153, 204);">throws</span> ClassNotFoundException {</div><div style="height:20px;">      <span style="color:rgb(204, 153, 204);">return</span> loadClass(className, <span style="color:rgb(204, 153, 204);">false</span>);</div><div style="height:20px;">  }</div><div style="height:20px;"></div><div style="height:20px;">  <span style="color:rgb(204, 153, 204);">protected</span> Class&lt;?&gt; loadClass(String className, <span style="color:rgb(204, 153, 204);">boolean</span> resolve) <span style="color:rgb(204, 153, 204);">throws</span> ClassNotFoundException {</div><div style="height:20px;">      Class&lt;?&gt; clazz = findLoadedClass(className);</div><div style="height:20px;">      <span style="color:rgb(204, 153, 204);">if</span> (clazz == <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">          ClassNotFoundException suppressed = <span style="color:rgb(204, 153, 204);">null</span>;</div><div style="height:20px;">          <span style="color:rgb(204, 153, 204);">try</span> {</div><div style="height:20px;">              clazz = parent.loadClass(className, <span style="color:rgb(204, 153, 204);">false</span>);</div><div style="height:20px;">          } <span style="color:rgb(204, 153, 204);">catch</span> (ClassNotFoundException e) {</div><div style="height:20px;">              suppressed = e;</div><div style="height:20px;">          }</div><div style="height:20px;"></div><div style="height:20px;">          <span style="color:rgb(204, 153, 204);">if</span> (clazz == <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">              <span style="color:rgb(204, 153, 204);">try</span> {</div><div style="height:20px;">                  clazz = findClass(className);</div><div style="height:20px;">              } <span style="color:rgb(204, 153, 204);">catch</span> (ClassNotFoundException e) {</div><div style="height:20px;">                  e.addSuppressed(suppressed);</div><div style="height:20px;">                  <span style="color:rgb(204, 153, 204);">throw</span> e;</div><div style="height:20px;">              }</div><div style="height:20px;">          }</div><div style="height:20px;">      }</div><div style="height:20px;">      <span style="color:rgb(204, 153, 204);">return</span> clazz;</div><div style="height:20px;">  }</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">loadClass方法调用了findClass方法，而BaseDexClassLoader重载了这个方法，得到BaseDexClassLoader看看<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(204, 153, 204);">@Override</span></div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">protected</span> Class&lt;?&gt; findClass(String name) <span style="color:rgb(204, 153, 204);">throws</span> ClassNotFoundException {</div><div style="height:20px;">        Class clazz = pathList.findClass(name);</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">if</span> (clazz == <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">            <span style="color:rgb(204, 153, 204);">throw</span> <span style="color:rgb(204, 153, 204);">new</span> ClassNotFoundException(name);</div><div style="height:20px;">        }</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">return</span> clazz;</div><div style="height:20px;">    }</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">结果还是调用了DexPathList的findClass<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">public</span> Class <span style="color:rgb(102, 204, 204);">findClass</span><span style="color:rgb(249, 145, 87);">(String name)</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">for</span> (Element element : dexElements) {</div><div style="height:20px;">        DexFile dex = element.dexFile;</div><div style="height:20px;">        <span style="color:rgb(204, 153, 204);">if</span> (dex != <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">            Class clazz = dex.loadClassBinaryName(name, definingContext);</div><div style="height:20px;">            <span style="color:rgb(204, 153, 204);">if</span> (clazz != <span style="color:rgb(204, 153, 204);">null</span>) {</div><div style="height:20px;">                <span style="color:rgb(204, 153, 204);">return</span> clazz;</div><div style="height:20px;">            }</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">return</span> <span style="color:rgb(204, 153, 204);">null</span>;</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">这里遍历了之前所有的DexFile实例，其实也就是遍历了所有加载过的dex文件，再调用loadClassBinaryName方法一个个尝试能不能加载想要的类，真是简单粗暴<br/></p><div style="display:block;margin:20px 0px;overflow:auto;padding:0px;font-size:13px;color:rgb(204, 204, 204);background:rgb(45, 45, 45);line-height:1.6;border-radius:1px;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;padding:10px 0px;margin:0px;border:none;color:rgb(153, 153, 153);padding-left:10px;padding-right:10px;text-align:right;background-color:rgb(27, 27, 27);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:normal;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="background:rgb(45, 45, 45);overflow:auto;font-size:13px;line-height:1.6;font-family:consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;color:rgb(204, 204, 204);padding:10px 0px;margin:0px;border:none;padding-left:10px;padding-right:10px;background-color:rgb(45, 45, 45);"><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">public</span> Class <span style="color:rgb(102, 204, 204);">loadClassBinaryName</span><span style="color:rgb(249, 145, 87);">(String name, ClassLoader loader)</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(204, 153, 204);">return</span> defineClass(name, loader, mCookie);</div><div style="height:20px;">}</div><div style="height:20px;"><span style="color:rgb(102, 153, 204);"><span style="color:rgb(204, 153, 204);">private</span> <span style="color:rgb(204, 153, 204);">native</span> <span style="color:rgb(204, 153, 204);">static</span> Class <span style="color:rgb(102, 204, 204);">defineClass</span><span style="color:rgb(249, 145, 87);">(String name, ClassLoader loader, <span style="color:rgb(204, 153, 204);">int</span> cookie)</span></span>;</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;"></p>
<p style="margin:0px 0px 25px;">看到这里想必大家都明白了，loadClassBinaryName中调用了Native方法defineClass加载类。</p>
<p style="margin:0px 0px 25px;">至此，ClassLoader的创建和加载类的过程的完成了。有趣的是，标准JVM中，ClassLoader是用defineClass加载类的，而Android中defineClass被弃用了，改用了loadClass方法，而且加载类的过程也挪到了DexFile中，在DexFile中加载类的具体方法也叫defineClass，不知道是Google故意写成这样的还是巧合。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#%E8%87%AA%E5%AE%9A%E4%B9%89ClassLoader" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="自定义ClassLoader"></a>自定义ClassLoader</h2><p style="margin:0px 0px 25px;">平时进行动态加载开发的时候，使用DexClassLoader就够了。但我们也可以创建自己的类去继承ClassLoader，需要注意的是loadClass方法并不是final类型的，所以我们可以重载loadClass方法并改写类的加载逻辑。</p>
<p style="margin:0px 0px 25px;">通过前面我们分析知道，ClassLoader双亲代理的实现很大一部分就是在loadClass方法里，我们可以通过重写loadClass方法避开双亲代理的框架，这样一来就可以在重新加载已经加载过的类，也可以在加载类的时候注入一些代码。这是一种Hack的开发方式，采用这种开发方式的程序稳定性可能比较差，但是却可以实现一些“黑科技”的功能。</p>
<h2 style="margin:20px 0px 15px;padding:0px;font-weight:bold;line-height:1.5;font-family:Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="http://kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/#Android%E7%A8%8B%E5%BA%8F%E6%AF%94%E8%B5%B7%E4%B8%80%E8%88%ACJava%E7%A8%8B%E5%BA%8F%E5%9C%A8%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%97%B6%E9%BA%BB%E7%83%A6%E5%9C%A8%E5%93%AA%E9%87%8C" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;" title="Android程序比起一般Java程序在使用动态加载时麻烦在哪里"></a>Android程序比起一般Java程序在使用动态加载时麻烦在哪里</h2><p style="margin:0px 0px 25px;">通过上面的分析，我们知道使用ClassLoader动态加载一个外部的类是非常容易的事情，所以很容易就能实现动态加载新的可执行代码的功能，但是比起一般的Java程序，在Android程序中使用动态加载主要有两个麻烦的问题：</p>
<ol>
<li>Android中许多组件类（如Activity、Service等）是需要在Manifest文件里面注册后才能工作的（系统会检查该组件有没有注册），所以即使动态加载了一个新的组件类进来，没有注册的话还是无法工作；</li>
<li>Res资源是Android开发中经常用到的，而Android是把这些资源用对应的R.id注册好，运行时通过这些ID从Resource实例中获取对应的资源。如果是运行时动态加载进来的新类，那类里面用到R.id的地方将会抛出找不到资源或者用错资源的异常，因为新类的资源ID根本和现有的Resource实例中保存的资源ID对不上；</li>
</ol>
<p style="margin:0px 0px 25px;">说到底，抛开虚拟机的差别不说，<strong style="font-weight:bold;">一个Android程序和标准的Java程序最大的区别就在于他们的上下文环境（Context）不同</strong>。Android中，这个环境可以给程序提供组件需要用到的功能，也可以提供一些主题、Res等资源，其实上面说到的两个问题都可以统一说是这个环境的问题，而现在的各种Android动态加载框架中，核心要解决的东西也正是“如何给外部的新类提供上下文环境”的问题。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <div style="display:block;">
      
        <div style="margin-top:40px;text-align:center;">
          
            <a href="http://kaedea.com/tags/Android/" rel="tag" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;display:inline-block;margin-right:10px;font-size:13px;"># Android</a>
          
            <a href="http://kaedea.com/tags/%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/" rel="tag" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;display:inline-block;margin-right:10px;font-size:13px;"># 动态加载</a>
          
            <a href="http://kaedea.com/tags/%E6%8F%92%E4%BB%B6%E5%8C%96/" rel="tag" style="background-color:transparent;color:rgb(85, 85, 85);text-decoration:none;border-bottom:1px solid rgb(153, 153, 153);word-wrap:break-word;display:inline-block;margin-right:10px;font-size:13px;"># 插件化</a>
          
        </div>
      

      
        <div style="display:table;margin-top:60px;width:100%;border-top:1px solid rgb(238, 238, 238);">
          <div style="display:table-cell;padding:10px 0px 0px;width:45%;vertical-align:top;">
            
              <a href="http://kaedea.com/2016/02/06/android-dynamical-loading-01-introduction/" rel="next" style="background-color:transparent;text-decoration:none;word-wrap:break-word;color:rgb(85, 85, 85);border-bottom:none;position:relative;display:block;line-height:25px;font-size:14px;padding-left:15px;" title="ANDROID动态加载简单易懂的介绍方式">
                <i style="font-family:FontAwesome;display:inline-block;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-style:normal;-webkit-font-smoothing:antialiased;text-rendering:auto;font-size:12px;position:absolute;top:8px;left:0px;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:12px;"></span></i> ANDROID动态加载简单易懂的介绍方式
              </a>
            
          </div>

          <span style="display:table-cell;width:10%;"></span>

          <div style="display:table-cell;padding:10px 0px 0px;width:45%;vertical-align:top;text-align:right;">
            
              <a href="http://kaedea.com/2016/02/08/android-about-source-code/" rel="prev" style="background-color:transparent;text-decoration:none;word-wrap:break-word;color:rgb(85, 85, 85);border-bottom:none;position:relative;display:block;line-height:25px;font-size:14px;padding-right:15px;" title="有没有必要阅读ANDROID源码">
                有没有必要阅读ANDROID源码 <i style="font-size:12px;display:inline-block;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-family:FontAwesome;font-style:normal;text-rendering:auto;-webkit-font-smoothing:antialiased;position:absolute;top:8px;left:auto;right:0px;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:12px;"></span></i>
              </a>
            
          </div>
        </div>
      

      
      
    </div>
  </div></div></div></div></div></span></div></div></div></div><br/></div></span>
</div></body></html> 