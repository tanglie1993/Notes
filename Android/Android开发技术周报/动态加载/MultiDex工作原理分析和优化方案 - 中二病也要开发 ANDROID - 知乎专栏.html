<html>
<head>
  <title>MultiDexå·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ - ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ ANDROID - çŸ¥ä¹ä¸“æ </title>
  <basefont face="å¾®è½¯é›…é»‘" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/10.0.15063 (Win64);"/>
  <style>
    body, td {
      font-family: å¾®è½¯é›…é»‘;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2625"/>
<h1>MultiDexå·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ - ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ ANDROID - çŸ¥ä¹ä¸“æ </h1>

<div><span><div style="-evernote-webclip:true"><br/><div><div><div><div><h1>MultiDexå·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ</h1><div><div></div></div></div>

      <div>
        
        
        
        <span>1 ä¸ªæœˆå‰</span>
      </div>
    

    

    <p>åŠ¨æ€åŠ è½½æŠ€æœ¯ï¼ˆæ’ä»¶åŒ–ï¼‰ç³»åˆ—å·²ç»å‘äº†æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä¸è¿‡UPä¸»æˆ‘å¹¶æ²¡æœ‰æ”¾å¼ƒæ²»ç–—å“ˆï¼Œç›¸ä¿¡åœ¨ä¸å°±çš„æœªæ¥å°±å¯ä»¥çœ‹åˆ°â€œç³»ç»ŸApi Hookæ¨¡å¼â€å’Œæ’ä»¶åŒ–æ¡†æ¶Frontiaçš„æ›´æ–°äº†ã€‚ä»Šå¤©è¦è®²çš„æ˜¯åŠ¨æ€åŠ è½½æŠ€æœ¯çš„äº²æˆš â€”â€” MultiDexã€‚ä»–ä»¬çš„æ ¸å¿ƒåŸç†ä¹‹ä¸€éƒ½æ˜¯dexæ–‡ä»¶çš„åŠ è½½ã€‚</p><p>MultiDexæ˜¯Googleä¸ºäº†è§£å†³â€œ<strong>65535æ–¹æ³•æ•°è¶…æ ‡</strong>â€ä»¥åŠâ€œ<strong>INSTALL_FAILED_DEXOPT</strong>â€é—®é¢˜è€Œå¼€å‘çš„ä¸€ä¸ªSupportåº“ï¼Œå…·ä½“å¦‚ä½•ä½¿ç”¨MultiDexç°åœ¨å¸‚é¢å·²ç»æœ‰ä¸€å¤§å †æ•™ç¨‹ï¼ˆå¯ä»¥å‚è€ƒ<a href="https://link.zhihu.com/?target=http%3A//kaedea.com/2015/09/02/android/enable-multidex/" target="_blank">ç»™ App å¯ç”¨ MultiDex åŠŸèƒ½</a>ï¼‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚è¿™ç¯‡æ—¥å¿—ä¸»è¦æ˜¯é…åˆæºç åˆ†æMultiDexçš„å·¥ä½œåŸç†ï¼Œä»¥åŠæä¾›ä¸€äº›MultiDexä¼˜åŒ–çš„æ–¹æ¡ˆã€‚</p><h2>Dexçš„å·¥ä½œæœºåˆ¶</h2><p>ç­‰ç­‰ï¼Œè¿™ä¸ªç« èŠ‚è®²çš„ä¸æ˜¯MultiDexå—ï¼Œæ€ä¹ˆå˜æˆDexäº†ï¼Ÿæ²¡é”™å“ˆï¼Œæ²¡æœ‰Dexï¼Œå“ªæ¥çš„MultiDexã€‚åœ¨Androidä¸­ï¼Œå¯¹Dexæ–‡ä»¶æ“ä½œå¯¹åº”çš„ç±»å«åšDexFileã€‚åœ¨<a href="https://link.zhihu.com/?target=http%3A//kaedea.com/2016/02/07/android-dynamical-loading-02-classloader/" target="_blank">CLASSLOADER çš„å·¥ä½œæœºåˆ¶</a>ä¸­ï¼Œæˆ‘ä»¬è¯´åˆ°ï¼š</p><blockquote><p>å¯¹äº Java ç¨‹åºæ¥è¯´ï¼Œç¼–å†™ç¨‹åºå°±æ˜¯ç¼–å†™ç±»ï¼Œè¿è¡Œç¨‹åºä¹Ÿå°±æ˜¯è¿è¡Œç±»ï¼ˆç¼–è¯‘å¾—åˆ°çš„classæ–‡ä»¶ï¼‰ï¼Œå…¶ä¸­èµ·åˆ°å…³é”®ä½œç”¨çš„å°±æ˜¯ç±»åŠ è½½å™¨ ClassLoaderã€‚</p></blockquote><p>Androidç¨‹åºçš„æ¯ä¸€ä¸ªClasséƒ½æ˜¯ç”±ClassLoader#loadClassæ–¹æ³•åŠ è½½è¿›å†…å­˜çš„ï¼Œæ›´å‡†ç¡®æ¥è¯´ï¼Œ<strong>ä¸€ä¸ªClassLoaderå®ä¾‹ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªDexFileå®ä¾‹</strong>ï¼Œè°ƒç”¨äº†ClassLoader#loadClassä¹‹åï¼ŒClassLoaderä¼šé€šè¿‡ç±»åï¼Œåœ¨è‡ªå·±çš„DexFileæ•°ç»„é‡Œé¢æŸ¥æ‰¾æœ‰æ²¡æœ‰é‚£ä¸ªDexFileå¯¹è±¡é‡Œé¢å­˜åœ¨è¿™ä¸ªç±»ï¼Œå¦‚æœéƒ½æ²¡æœ‰å°±æŠ›ClassNotFoundå¼‚å¸¸ã€‚ClassLoaderé€šè¿‡è°ƒç”¨DexFileçš„ä¸€ä¸ªå«defineClassçš„Nativeæ–¹æ³•å»åŠ è½½æŒ‡å®šçš„ç±»ï¼Œè¿™ç‚¹ä¸JVMç•¥æœ‰ä¸åŒï¼Œåè€…æ˜¯ç›´æ¥è°ƒç”¨ClassLoader#defineCLassæ–¹æ³•ï¼Œåæ­£æœ€åå®é™…åŠ è½½ç±»çš„æ–¹æ³•éƒ½å«defineClasså°±æ²¡é”™äº†ğŸŒã€‚</p><h3>åˆ›å»ºDexFileå¯¹è±¡</h3><p>é¦–å…ˆæ¥çœ‹çœ‹é€ DexFileå¯¹è±¡çš„æ„æ–¹æ³•ã€‚</p><div><pre><code>public final class DexFile {
    private int mCookie;
    private final String mFileName;
    ...
 
    public DexFile(File file) throws IOException {
        this(file.getPath());
    }
 
    public DexFile(String fileName) throws IOException {
        mCookie = openDexFile(fileName, null, 0);
        mFileName = fileName;
        guard.open(&quot;close&quot;);
    }
 
    private DexFile(String sourceName, String outputName, int flags) throws IOException {
        mCookie = openDexFile(sourceName, outputName, flags);
        mFileName = sourceName;
        guard.open(&quot;close&quot;);
    }
 
    static public DexFile loadDex(String sourcePathName, String outputPathName,
        int flags) throws IOException {
        return new DexFile(sourcePathName, outputPathName, flags);
    }
 
    public Class loadClass(String name, ClassLoader loader) {
        String slashName = name.replace('.', '/');
        return loadClassBinaryName(slashName, loader);
    }
 
    public Class loadClassBinaryName(String name, ClassLoader loader) {
        return defineClass(name, loader, mCookie);
    }
    private native static Class defineClass(String name, ClassLoader loader, int cookie);
 
    native private static int openDexFile(String sourceName, String outputName,
        int flags) throws IOException;
 
    native private static int openDexFile(byte[] fileContents)
    ...
}
 
</code></pre></div><p>é€šè¿‡ä»¥å‰åˆ†æè¿‡çš„æºç ï¼Œæˆ‘ä»¬çŸ¥é“ClassLoaderä¸»è¦æ˜¯é€šè¿‡DexFile.loadDexè¿™ä¸ªé™æ€æ–¹æ³•æ¥åˆ›å»ºå®ƒéœ€è¦çš„DexFileå®ä¾‹çš„ï¼Œè¿™é‡Œåˆ›å»ºDexFileçš„æ—¶å€™ï¼Œä¿å­˜äº†Dexæ–‡ä»¶çš„æ–‡ä»¶è·¯å¾„mFileNameï¼Œ<strong>åŒæ—¶è°ƒç”¨äº†openDexFileçš„Nativeæ–¹æ³•æ‰“å¼€Dexæ–‡ä»¶</strong>å¹¶è¿”å›äº†ä¸€ä¸ªmCookieçš„æ•´å‹å˜é‡ï¼ˆæˆ‘ä¸çŸ¥é“è¿™ä¸ªå¹²å•¥ç”¨çš„ï¼Œæˆ‘çŒœå®ƒæ˜¯ä¸€ä¸ªC++ç”¨çš„èµ„æºå¥æŸ„ï¼Œç”¨äºNativeå±‚è®¿é—®å…·ä½“çš„Dexæ–‡ä»¶ï¼‰ã€‚åœ¨Nativeå±‚çš„openDexFileæ–¹æ³•é‡Œï¼Œä¸»è¦åšäº†æ£€æŸ¥å½“å‰åˆ›å»ºæ¥çš„Dexæ–‡ä»¶æ˜¯å¦æ˜¯æœ‰æ•ˆçš„Dexæ–‡ä»¶ï¼Œè¿˜æ˜¯æ˜¯ä¸€ä¸ªå¸¦æœ‰Dexæ–‡ä»¶çš„å‹ç¼©åŒ…ï¼Œè¿˜æ˜¯ä¸€ä¸ªæ— æ•ˆçš„Dexæ–‡ä»¶ã€‚</p><h3>åŠ è½½Dexæ–‡ä»¶é‡Œçš„ç±»</h3><p>åŠ è½½ç±»çš„æ—¶å€™ï¼ŒClassLoaderåˆæ˜¯é€šè¿‡DexFile#loadClassè¿™ä¸ªæ–¹æ³•æ¥å®Œæˆçš„ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œè°ƒç”¨äº†defineClassè¿™ä¸ªNativeæ–¹æ³•ï¼Œ<strong>çœ‹æ¥DexFileæ‰æ˜¯åŠ è½½Classçš„å…·ä½“APIï¼ŒåŠ è½½Dexæ–‡ä»¶å’ŒåŠ è½½å…·ä½“Classéƒ½æ˜¯é€šè¿‡Nativeæ–¹æ³•å®Œæˆ</strong>ï¼ŒClassLoaderæœ‰ç‚¹åä¸å‰¯å®å•Šã€‚</p><h2>MultiDexçš„å·¥ä½œæœºåˆ¶</h2><p>å½“ä¸€ä¸ªDexæ–‡ä»¶å¤ªè‚¥çš„æ—¶å€™ï¼ˆæ–¹æ³•æ•°ç›®å¤ªå¤šã€æ–‡ä»¶å¤ªå¤§ï¼‰ï¼Œåœ¨æ‰“åŒ…Apkæ–‡ä»¶çš„æ—¶å€™å°±ä¼šå‡ºé—®é¢˜ï¼Œå°±ç®—æ‰“åŒ…çš„æ—¶å€™ä¸å‡ºé—®é¢˜ï¼Œåœ¨Android 5.0ä»¥ä¸‹è®¾å¤‡ä¸Šå®‰è£…æˆ–è¿è¡ŒApkä¹Ÿä¼šå‡ºé—®é¢˜ï¼ˆå…·ä½“åŸå› å¯ä»¥å‚è€ƒ<a href="https://link.zhihu.com/?target=http%3A//kaedea.com/2015/09/02/android/enable-multidex/" target="_blank">ç»™ App å¯ç”¨ MultiDex åŠŸèƒ½</a>ï¼‰ã€‚æ—¢ç„¶ä¸€ä¸ªDexæ–‡ä»¶ä¸è¡Œçš„è¯ï¼Œé‚£å°±æŠŠè¿™ä¸ªç¡•å¤§çš„Dexæ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„Dexæ–‡ä»¶ï¼Œåˆšå¥½ä¸€ä¸ªClassLoaderå¯ä»¥æœ‰å¤šä¸ªDexFileï¼Œè¿™å°±æ˜¯MultiDexçš„åŸºæœ¬è®¾è®¡æ€è·¯ã€‚</p><h3>å·¥ä½œæµç¨‹</h3><p>MultiDexçš„å·¥ä½œæµç¨‹å…·ä½“åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯æ‰“åŒ…æ„å»ºApkçš„æ—¶å€™ï¼Œå°†Dexæ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„Dexæ–‡ä»¶ï¼Œè¿™ä¸ªAndroid Studioå·²ç»å¸®æˆ‘ä»¬åšäº†ï¼ˆè®¾ç½® â€œmultiDexEnabled trueâ€ï¼‰ï¼Œå¦ä¸€éƒ¨åˆ†å°±æ˜¯åœ¨å¯åŠ¨Apkçš„æ—¶å€™ï¼ŒåŒæ—¶åŠ è½½å¤šä¸ªDexæ–‡ä»¶ï¼ˆå…·ä½“æ˜¯åŠ è½½Dexæ–‡ä»¶ä¼˜åŒ–åçš„Odexæ–‡ä»¶ï¼Œä¸è¿‡æ–‡ä»¶åè¿˜æ˜¯.dexï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†å·¥ä½œä»Android 5.0å¼€å§‹ç³»ç»Ÿå·²ç»å¸®æˆ‘ä»¬åšäº†ï¼Œä½†æ˜¯åœ¨Android 5.0ä»¥å‰è¿˜æ˜¯éœ€è¦é€šè¿‡MultiDex Supportåº“æ¥æ”¯æŒï¼ˆMultiDex.install(Context)ï¼‰ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…³å¿ƒçš„æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ç®€å•ç¤ºæ„æµç¨‹å›¾å¦‚ä¸‹ã€‚</p><div><img src="MultiDexå·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ - ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ ANDROID - çŸ¥ä¹ä¸“æ _files/v2-95481e331bf6267d1390bee42f993ac1_b.png" type="image/png" data-filename="v2-95481e331bf6267d1390bee42f993ac1_b.png" height="488" width="403"/></div><p>ï¼ˆå›¾ä¸­çº¢è‰²éƒ¨åˆ†ä¸ºè€—æ—¶æ¯”è¾ƒå¤§çš„åœ°æ–¹ï¼‰</p><h3>æºç åˆ†æ</h3><p>ç°åœ¨å®˜æ–¹å·²ç»éƒ¨ç½²çš„MultiDex Supportç‰ˆæœ¬æ˜¯com.android.support:multidex:1.0.1ï¼Œä½†æ˜¯ç°åœ¨ä»“åº“çš„masteråˆ†æ”¯å·²ç»æœ‰äº†è®¸å¤šæ–°çš„æäº¤ï¼ˆå…¶ä¸­æœ€æ˜æ˜¾çš„åŒºåˆ«æ˜¯åŠ å…¥äº†FileLockæ¥æ§åˆ¶å¤šè¿›ç¨‹åŒæ­¥é—®é¢˜ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†æçš„æºç éƒ½æ˜¯æœ€æ–°çš„masteråˆ†æ”¯ä¸Šçš„ã€‚</p><p>MultiDex Supportçš„å…¥å£æ˜¯MultiDex.install(Context)ï¼Œå…ˆä»è¿™é‡Œå…¥æ‰‹å§ã€‚ï¼ˆè¿™æ¬¡æˆ‘æŠŠå…·ä½“çš„åˆ†æéƒ½å†™åœ¨ä»£ç çš„æ³¨é‡Šäº†ï¼Œè¿™æ ·çœ‹æ˜¯ä¸æ˜¯æ›´ç®€æ´æ˜äº†äº›ï¼Ÿï¼‰</p><div><pre><code>public static void install(Context context) {
    Log.i(TAG, &quot;install&quot;);
    // 1. åˆ¤è¯»æ˜¯å¦éœ€è¦æ‰§è¡ŒMultiDexã€‚
    if (IS_VM_MULTIDEX_CAPABLE) {
        Log.i(TAG, &quot;VM has multidex support, MultiDex support library is disabled.&quot;);
        return;
    }
    if (Build.VERSION.SDK_INT &lt; MIN_SDK_VERSION) {
        throw new RuntimeException(&quot;Multi dex installation failed. SDK &quot; + Build.VERSION.SDK_INT
                + &quot; is unsupported. Min SDK version is &quot; + MIN_SDK_VERSION + &quot;.&quot;);
    }
    try {
        ApplicationInfo applicationInfo = getApplicationInfo(context);
        if (applicationInfo == null) {
            // Looks like running on a test Context, so just return without patching.
            return;
        }
        // 2. å¦‚æœè¿™ä¸ªæ–¹æ³•å·²ç»è°ƒç”¨è¿‡ä¸€æ¬¡ï¼Œå°±ä¸èƒ½å†è°ƒç”¨äº†ã€‚
        synchronized (installedApk) {
            String apkPath = applicationInfo.sourceDir;
            if (installedApk.contains(apkPath)) {
                return;
            }
            installedApk.add(apkPath);
            // 3. å¦‚æœå½“å‰Androidç‰ˆæœ¬å·²ç»è‡ªèº«æ”¯æŒäº†MultiDexï¼Œä¾ç„¶å¯ä»¥æ‰§è¡ŒMultiDexæ“ä½œï¼Œ
            // ä½†æ˜¯ä¼šæœ‰è­¦å‘Šã€‚
            if (Build.VERSION.SDK_INT &gt; MAX_SUPPORTED_SDK_VERSION) {
                Log.w(TAG, &quot;MultiDex is not guaranteed to work in SDK version &quot;
                        + Build.VERSION.SDK_INT + &quot;: SDK version higher than &quot;
                        + MAX_SUPPORTED_SDK_VERSION + &quot; should be backed by &quot;
                        + &quot;runtime with built-in multidex capabilty but it's not the &quot;
                        + &quot;case here: java.vm.version=\&quot;&quot;
                        + System.getProperty(&quot;java.vm.version&quot;) + &quot;\&quot;&quot;);
            }
            // 4. è·å–å½“å‰çš„ClassLoaderå®ä¾‹ï¼Œåé¢è¦åšçš„å·¥ä½œï¼Œå°±æ˜¯æŠŠå…¶ä»–dexæ–‡ä»¶åŠ è½½åï¼Œ
            // æŠŠå…¶DexFileå¯¹è±¡æ·»åŠ åˆ°è¿™ä¸ªClassLoaderå®ä¾‹é‡Œå°±å®Œäº‹äº†ã€‚
            ClassLoader loader;
            try {
                loader = context.getClassLoader();
            } catch (RuntimeException e) {
                Log.w(TAG, &quot;Failure while trying to obtain Context class loader. &quot; +
                        &quot;Must be running in test mode. Skip patching.&quot;, e);
                return;
            }
            if (loader == null) {
                Log.e(TAG,
                        &quot;Context class loader is null. Must be running in test mode. &quot;
                        + &quot;Skip patching.&quot;);
                return;
            }
            try {
              // 5. æ¸…é™¤æ—§çš„dexæ–‡ä»¶ï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯æ¸…é™¤ä¸Šæ¬¡åŠ è½½çš„dexæ–‡ä»¶ç¼“å­˜ã€‚
              // è·å–dexç¼“å­˜ç›®å½•æ˜¯ï¼Œä¼šä¼˜å…ˆè·å–/data/data/&lt;package&gt;/code-cacheä½œä¸ºç¼“å­˜ç›®å½•ã€‚
              // å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™ä½¿ç”¨/data/data/&lt;package&gt;/files/code-cacheç›®å½•ã€‚
              // è¿™é‡Œæ¸…é™¤çš„æ˜¯ç¬¬äºŒä¸ªç›®å½•ã€‚
              clearOldDexDir(context);
            } catch (Throwable t) {
              Log.w(TAG, &quot;Something went wrong when trying to clear old MultiDex extraction, &quot;
                  + &quot;continuing without cleaning.&quot;, t);
            }
            // 6. è·å–ç¼“å­˜ç›®å½•ï¼ˆ/data/data/&lt;package&gt;/code-cacheï¼‰ã€‚
            File dexDir = getDexDir(context, applicationInfo);
            // 7. åŠ è½½ç¼“å­˜æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
            List&lt;File&gt; files = MultiDexExtractor.load(context, applicationInfo, dexDir, false);
            // 8. æ£€æŸ¥ç¼“å­˜çš„dexæ˜¯å¦å®‰å…¨
            if (checkValidZipFiles(files)) {
                // 9. å®‰è£…ç¼“å­˜çš„dex
                installSecondaryDexes(loader, dexDir, files);
            } else {
                // 9. ä»apkå‹ç¼©åŒ…é‡Œé¢æå–dexæ–‡ä»¶
                Log.w(TAG, &quot;Files were not valid zip files.  Forcing a reload.&quot;);
                files = MultiDexExtractor.load(context, applicationInfo, dexDir, true);
                if (checkValidZipFiles(files)) {
                    // 10. å®‰è£…æå–çš„dex
                    installSecondaryDexes(loader, dexDir, files);
                } else {
                    throw new RuntimeException(&quot;Zip files were not valid.&quot;);
                }
            }
        }
    } catch (Exception e) {
        Log.e(TAG, &quot;Multidex installation failure&quot;, e);
        throw new RuntimeException(&quot;Multi dex installation failed (&quot; + e.getMessage() + &quot;).&quot;);
    }
    Log.i(TAG, &quot;install done&quot;);
}
</code></pre></div><p>å…·ä½“ä»£ç çš„åˆ†æå·²ç»åœ¨ä¸Šé¢ä»£ç çš„æ³¨é‡Šé‡Œç»™å‡ºäº†ï¼Œä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ªMultiDex.install(Context)çš„è¿‡ç¨‹ä¸­ï¼Œå…³é”®çš„æ­¥éª¤å°±æ˜¯MultiDexExtractor#loadæ–¹æ³•å’ŒMultiDex#installSecondaryDexesæ–¹æ³•ã€‚</p><p>ï¼ˆè¿™éƒ¨åˆ†æ˜¯é¢˜å¤–è¯ï¼‰å…¶ä¸­æœ‰ä¸ª<strong>MultiDex#clearOldDexDir(Context)</strong>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ é™¤<strong>/data/data//files/code-cache</strong>ï¼Œä¸€å¼€å§‹æˆ‘ä»¥ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯åˆ é™¤ä¸Šä¸€æ¬¡æ‰§è¡ŒMultiDexåçš„ç¼“å­˜æ–‡ä»¶ï¼Œä¸è¿‡è¿™æ˜æ˜¾ä¸å¯¹ï¼Œä¸å¯èƒ½æ¯æ¬¡MultiDexéƒ½é‡æ–°è§£å‹dexæ–‡ä»¶ä¸€è¾¹ï¼Œè¿™æ ·æ¯æ¬¡å¯åŠ¨ä¼šå¾ˆè€—æ—¶ï¼Œ<strong>åªæœ‰ç¬¬ä¸€æ¬¡å†·å¯åŠ¨çš„æ—¶å€™æ‰éœ€è¦è§£å‹dexæ–‡ä»¶</strong>ã€‚åæ¥æˆ‘åˆæƒ³æ˜¯ä¸æ˜¯ä»¥å‰æ—§ç‰ˆçš„MultiDexæ›¾ç»æŠŠç¼“å­˜æ–‡ä»¶æ”¾åœ¨è¿™ä¸ªç›®å½•é‡Œï¼Œç°åœ¨æ–°ç‰ˆæœ¬åªæ˜¯æ¸…é™¤ä»¥å‰æ—§ç‰ˆçš„é—ç•™æ–‡ä»¶ï¼Ÿä½†æ˜¯æˆ‘æ‰¾éäº†æ•´ä¸ªMultiDex Repoçš„æäº¤ä¹Ÿæ²¡æœ‰è§è¿‡ç±»ä¼¼çš„æ—§ç‰ˆæœ¬ä»£ç ã€‚åé¢æˆ‘ä»”ç»†çœ‹<strong>MultiDex#getDexDir</strong>è¿™ä¸ªæ–¹æ³•æ‰å‘ç°ï¼ŒåŸæ¥MultiDexåœ¨è·å–dexç¼“å­˜ç›®å½•æ˜¯ï¼Œä¼šä¼˜å…ˆè·å–<strong>/data/data//code-cache</strong>ä½œä¸ºç¼“å­˜ç›®å½•ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™ä½¿ç”¨<strong>/data/data//files/code-cache</strong>ç›®å½•ï¼Œè€Œåè€…çš„ç¼“å­˜æ–‡ä»¶ä¼šåœ¨æ¯æ¬¡Appé‡æ–°å¯åŠ¨çš„æ—¶å€™è¢«æ¸…é™¤ã€‚æ„Ÿè§‰MultiDexè·å–ç¼“å­˜ç›®å½•çš„é€»è¾‘ä¸æ˜¯å¾ˆä¸¥è°¨ï¼Œè€Œè·å–ç¼“å­˜ç›®å½•å¤±è´¥ä¹Ÿæ˜¯MultiDexå·¥ä½œå·¥ç¨‹ä¸­å°‘æ•°æœ‰é‡è¯•æœºåˆ¶çš„åœ°æ–¹ï¼Œçœ‹æ¥MultiDexçœŸçš„æ˜¯ä¸€ä¸ªä¸´æ—¶çš„å…¼å®¹æ–¹æ¡ˆï¼ŒGoogleä¹Ÿè®¸å¹¶ä¸æ‰“ç®—è®¤çœŸå¤„ç†è¿™äº›å†å²çš„é»‘é”…ã€‚</p><p>æ¥ä¸‹æ¥å†çœ‹çœ‹MultiDexExtractor#loadè¿™ä¸ªæ–¹æ³•ã€‚</p><div><pre><code>static List&lt;File&gt; load(Context context, ApplicationInfo applicationInfo, File dexDir,
            boolean forceReload) throws IOException {
        Log.i(TAG, &quot;MultiDexExtractor.load(&quot; + applicationInfo.sourceDir + &quot;, &quot; + forceReload + &quot;)&quot;);
        final File sourceApk = new File(applicationInfo.sourceDir);
        // 1. è·å–å½“å‰Apkæ–‡ä»¶çš„crcå€¼ã€‚
        long currentCrc = getZipCrc(sourceApk);
        // Validity check and extraction must be done only while the lock file has been taken.
        File lockFile = new File(dexDir, LOCK_FILENAME);
        RandomAccessFile lockRaf = new RandomAccessFile(lockFile, &quot;rw&quot;);
        FileChannel lockChannel = null;
        FileLock cacheLock = null;
        List&lt;File&gt; files;
        IOException releaseLockException = null;
        try {
            lockChannel = lockRaf.getChannel();
            Log.i(TAG, &quot;Blocking on lock &quot; + lockFile.getPath());
            // 2. åŠ ä¸Šæ–‡ä»¶é”ï¼Œé˜²æ­¢å¤šè¿›ç¨‹å†²çªã€‚
            cacheLock = lockChannel.lock();
            Log.i(TAG, lockFile.getPath() + &quot; locked&quot;);
            // 3. å…ˆåˆ¤æ–­æ˜¯å¦å¼ºåˆ¶é‡æ–°è§£å‹ï¼Œè¿™é‡Œç¬¬ä¸€æ¬¡ä¼šä¼˜å…ˆä½¿ç”¨å·²è§£å‹è¿‡çš„dexæ–‡ä»¶ï¼Œå¦‚æœåŠ è½½å¤±è´¥å°±å¼ºåˆ¶é‡æ–°è§£å‹ã€‚
            // æ­¤å¤–ï¼Œé€šè¿‡crcå’Œæ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼Œåˆ¤æ–­å¦‚æœApkæ–‡ä»¶å·²ç»è¢«ä¿®æ”¹ï¼ˆè¦†ç›–å®‰è£…ï¼‰ï¼Œå°±ä¼šè·³è¿‡ç¼“å­˜é‡æ–°è§£å‹dexæ–‡ä»¶ã€‚
            if (!forceReload &amp;&amp; !isModified(context, sourceApk, currentCrc)) {
                try {
                    // 4. åŠ è½½ç¼“å­˜çš„dexæ–‡ä»¶
                    files = loadExistingExtractions(context, sourceApk, dexDir);
                } catch (IOException ioe) {
                    Log.w(TAG, &quot;Failed to reload existing extracted secondary dex files,&quot;
                            + &quot; falling back to fresh extraction&quot;, ioe);
                    // 5. åŠ è½½å¤±è´¥çš„è¯é‡æ–°è§£å‹ï¼Œå¹¶ä¿å­˜è§£å‹å‡ºæ¥çš„dexæ–‡ä»¶çš„ä¿¡æ¯ã€‚
                    files = performExtractions(sourceApk, dexDir);
                    putStoredApkInfo(context,
                            getTimeStamp(sourceApk), currentCrc, files.size() + 1);
                }
            } else {
                // 4. é‡æ–°è§£å‹ï¼Œå¹¶ä¿å­˜è§£å‹å‡ºæ¥çš„dexæ–‡ä»¶çš„ä¿¡æ¯ã€‚
                Log.i(TAG, &quot;Detected that extraction must be performed.&quot;);
                files = performExtractions(sourceApk, dexDir);
                putStoredApkInfo(context, getTimeStamp(sourceApk), currentCrc, files.size() + 1);
            }
        } finally {
            if (cacheLock != null) {
                try {
                    cacheLock.release();
                } catch (IOException e) {
                    Log.e(TAG, &quot;Failed to release lock on &quot; + lockFile.getPath());
                    // Exception while releasing the lock is bad, we want to report it, but not at
                    // the price of overriding any already pending exception.
                    releaseLockException = e;
                }
            }
            if (lockChannel != null) {
                closeQuietly(lockChannel);
            }
            closeQuietly(lockRaf);
        }
        if (releaseLockException != null) {
            throw releaseLockException;
        }
        Log.i(TAG, &quot;load found &quot; + files.size() + &quot; secondary dex files&quot;);
        return files;
    }
</code></pre></div><p>è¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯è·å–å¯ä»¥å®‰è£…çš„dexæ–‡ä»¶åˆ—è¡¨ï¼Œå¯ä»¥æ˜¯ä¸Šæ¬¡è§£å‹å‡ºæ¥çš„ç¼“å­˜æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯é‡æ–°ä»ApkåŒ…é‡Œé¢æå–å‡ºæ¥çš„ã€‚éœ€è¦æ³¨æ„çš„æ—¶ï¼Œå¦‚æœæ˜¯é‡æ–°è§£å‹ï¼Œè¿™é‡Œä¼šæœ‰æ˜æ˜¾çš„è€—æ—¶ï¼Œè€Œä¸”è§£å‹å‡ºæ¥çš„dexæ–‡ä»¶ï¼Œä¼šè¢«å‹ç¼©æˆ.zipå‹ç¼©åŒ…ï¼Œå‹ç¼©çš„è¿‡ç¨‹ä¹Ÿä¼šæœ‰æ˜æ˜¾çš„è€—æ—¶ï¼ˆè¿™é‡Œå‹ç¼©dexæ–‡ä»¶å¯èƒ½æ˜¯é—®äº†èŠ‚çœç©ºé—´ï¼‰ã€‚</p><p>å¦‚æœdexæ–‡ä»¶æ˜¯é‡æ–°è§£å‹å‡ºæ¥çš„ï¼Œåˆ™ä¼šä¿å­˜dexæ–‡ä»¶çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è§£å‹çš„apkæ–‡ä»¶çš„crcå€¼ã€ä¿®æ”¹æ—¶é—´ä»¥åŠdexæ–‡ä»¶çš„æ•°ç›®ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å¯åŠ¨ç›´æ¥ä½¿ç”¨å·²ç»è§£å‹è¿‡çš„dexç¼“å­˜æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¯ä¸€æ¬¡éƒ½é‡æ–°è§£å‹ã€‚</p><p>éœ€è¦ç‰¹åˆ«æåˆ°çš„æ˜¯ï¼Œé‡Œé¢çš„<strong>FileLock</strong>æ˜¯æœ€æ–°çš„masteråˆ†æ”¯é‡Œé¢æ–°åŠ è¿›å»çš„åŠŸèƒ½ï¼Œç°åœ¨æœ€æ–°çš„1.0.1ç‰ˆæœ¬é‡Œé¢æ˜¯æ²¡æœ‰çš„ã€‚</p><p>æ— è®ºæ˜¯é€šè¿‡ä½¿ç”¨ç¼“å­˜çš„dexæ–‡ä»¶ï¼Œè¿˜æ˜¯é‡æ–°ä»apkä¸­è§£å‹dexæ–‡ä»¶ï¼Œè·å–dexæ–‡ä»¶åˆ—è¡¨åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å®‰è£…ï¼ˆæˆ–è€…è¯´åŠ è½½ï¼‰è¿™äº›dexæ–‡ä»¶äº†ã€‚æœ€åçš„å·¥ä½œåœ¨MultiDex#installSecondaryDexesè¿™ä¸ªæ–¹æ³•é‡Œé¢ã€‚</p><div><pre><code>private static void installSecondaryDexes(ClassLoader loader, File dexDir, List&lt;File&gt; files)
            throws IllegalArgumentException, IllegalAccessException, NoSuchFieldException,
            InvocationTargetException, NoSuchMethodException, IOException {
        if (!files.isEmpty()) {
            if (Build.VERSION.SDK_INT &gt;= 19) {
                V19.install(loader, files, dexDir);

            } else if (Build.VERSION.SDK_INT &gt;= 14) {
                V14.install(loader, files, dexDir);
            } else {
                V4.install(loader, files);
            }
        }

    }
</code></pre></div><p>å› ä¸ºåœ¨ä¸åŒçš„SDKç‰ˆæœ¬ä¸Šï¼ŒClassLoaderï¼ˆæ›´å‡†ç¡®æ¥è¯´æ˜¯DexClassLoaderï¼‰åŠ è½½dexæ–‡ä»¶çš„æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥è¿™é‡Œåšäº†V4/V14/V19çš„å…¼å®¹ï¼ˆMagic Codeï¼‰ã€‚</p><p>Build.VERSION.SDK_INT &lt; 14</p><div><pre><code>/**
 * Installer for platform versions 4 to 13.
 */
private static final class V4 {
    private static void install(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries)
                    throws IllegalArgumentException, IllegalAccessException,
                    NoSuchFieldException, IOException {
        int extraSize = additionalClassPathEntries.size();
        Field pathField = findField(loader, &quot;path&quot;);
        StringBuilder path = new StringBuilder((String) pathField.get(loader));
        String[] extraPaths = new String[extraSize];
        File[] extraFiles = new File[extraSize];
        ZipFile[] extraZips = new ZipFile[extraSize];
        DexFile[] extraDexs = new DexFile[extraSize];
        for (ListIterator&lt;File&gt; iterator = additionalClassPathEntries.listIterator();
                iterator.hasNext();) {
            File additionalEntry = iterator.next();
            String entryPath = additionalEntry.getAbsolutePath();
            path.append(':').append(entryPath);
            int index = iterator.previousIndex();
            extraPaths[index] = entryPath;
            extraFiles[index] = additionalEntry;
            extraZips[index] = new ZipFile(additionalEntry);
            extraDexs[index] = DexFile.loadDex(entryPath, entryPath + &quot;.dex&quot;, 0);
        }
        // è¿™ä¸ªç‰ˆæœ¬æ˜¯æœ€ç®€å•çš„ã€‚
        // åªéœ€è¦åˆ›å»ºDexFileå¯¹è±¡åï¼Œä½¿ç”¨åå°„çš„æ–¹æ³•åˆ†åˆ«æ‰©å±•ClassLoaderå®ä¾‹çš„ä»¥ä¸‹å­—æ®µå³å¯ã€‚
        pathField.set(loader, path.toString());
        expandFieldArray(loader, &quot;mPaths&quot;, extraPaths);
        expandFieldArray(loader, &quot;mFiles&quot;, extraFiles);
        expandFieldArray(loader, &quot;mZips&quot;, extraZips);
        expandFieldArray(loader, &quot;mDexs&quot;, extraDexs);
    }
}
</code></pre></div><p>14 &lt;= Build.VERSION.SDK_INT &lt; 19</p><div><pre><code>/**
 * Installer for platform versions 14, 15, 16, 17 and 18.
 */
private static final class V14 {
    private static void install(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries,
            File optimizedDirectory)
                    throws IllegalArgumentException, IllegalAccessException,
                    NoSuchFieldException, InvocationTargetException, NoSuchMethodException {
        // æ‰©å±•ClassLoaderå®ä¾‹çš„&quot;pathList&quot;å­—æ®µã€‚
        Field pathListField = findField(loader, &quot;pathList&quot;);
        Object dexPathList = pathListField.get(loader);
        expandFieldArray(dexPathList, &quot;dexElements&quot;, makeDexElements(dexPathList,
                new ArrayList&lt;File&gt;(additionalClassPathEntries), optimizedDirectory));
    }
    private static Object[] makeDexElements(
            Object dexPathList, ArrayList&lt;File&gt; files, File optimizedDirectory)
                    throws IllegalAccessException, InvocationTargetException,
                    NoSuchMethodException {
        Method makeDexElements =
                findMethod(dexPathList, &quot;makeDexElements&quot;, ArrayList.class, File.class);
        return (Object[]) makeDexElements.invoke(dexPathList, files, optimizedDirectory);
    }
}
</code></pre></div><p>ä»API14å¼€å§‹ï¼ŒDexClassLoaderä¼šä½¿ç”¨ä¸€ä¸ªDexpDexPathListç±»æ¥å°è£…DexFileæ•°ç»„ã€‚</p><div><pre><code>final class DexPathList {
    private static final String DEX_SUFFIX = &quot;.dex&quot;;
    private static final String JAR_SUFFIX = &quot;.jar&quot;;
    private static final String ZIP_SUFFIX = &quot;.zip&quot;;
    private static final String APK_SUFFIX = &quot;.apk&quot;;
 

    private static Element[] makeDexElements(ArrayList&lt;File&gt; files,
            File optimizedDirectory) {
        ArrayList&lt;Element&gt; elements = new ArrayList&lt;Element&gt;();
        for (File file : files) {
            ZipFile zip = null;
            DexFile dex = null;

            String name = file.getName();
            if (name.endsWith(DEX_SUFFIX)) {
                // Raw dex file (not inside a zip/jar).
                try {
                    dex = loadDexFile(file, optimizedDirectory);
                } catch (IOException ex) {

                    System.logE(&quot;Unable to load dex file: &quot; + file, ex);
                }
            } else if (name.endsWith(APK_SUFFIX) || name.endsWith(JAR_SUFFIX)
                    || name.endsWith(ZIP_SUFFIX)) {
                try {
                    zip = new ZipFile(file);

                } catch (IOException ex) {
                    System.logE(&quot;Unable to open zip file: &quot; + file, ex);
                }
                try {
                    dex = loadDexFile(file, optimizedDirectory);
                } catch (IOException ignored) {

 
                }
            } else {
                System.logW(&quot;Unknown file type for: &quot; + file);
            }
            if ((zip != null) || (dex != null)) {

                elements.add(new Element(file, zip, dex));
            }
        }
        return elements.toArray(new Element[elements.size()]);
    }
 

    private static DexFile loadDexFile(File file, File optimizedDirectory)
            throws IOException {
        if (optimizedDirectory == null) {
            return new DexFile(file);
        } else {
            String optimizedPath = optimizedPathFor(file, optimizedDirectory);

            return DexFile.loadDex(file.getPath(), optimizedPath, 0);
        }
    }
}
</code></pre></div><p>é€šè¿‡è°ƒç”¨<strong>DexPathList#makeDexElements</strong>æ–¹æ³•ï¼Œå¯ä»¥åŠ è½½æˆ‘ä»¬ä¸Šé¢è§£å‹å¾—åˆ°çš„dexæ–‡ä»¶ï¼Œä»ä»£ç ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œ<strong>DexPathList#makeDexElements</strong>å…¶å®ä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨<strong>DexFile#loadDex</strong>æ¥åŠ è½½dexæ–‡ä»¶å¹¶åˆ›å»ºDexFileå¯¹è±¡çš„ã€‚V14ä¸­ï¼Œé€šè¿‡åå°„è°ƒç”¨<strong>DexPathList#makeDexElements</strong>æ–¹æ³•åŠ è½½æˆ‘ä»¬éœ€è¦çš„dexæ–‡ä»¶ï¼Œåœ¨æŠŠåŠ è½½å¾—åˆ°çš„æ•°ç»„æ‰©å±•åˆ°ClassLoaderå®ä¾‹çš„&quot;pathList&quot;å­—æ®µï¼Œä»è€Œå®Œæˆdexæ–‡ä»¶çš„å®‰è£…ã€‚</p><p>ä»DexPathListçš„ä»£ç ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒClassLoaderæ˜¯æ”¯æŒç›´æ¥åŠ è½½.dex/.zip/.jar/.apkçš„dexæ–‡ä»¶åŒ…çš„ï¼ˆæˆ‘è®°å¾—ä»¥å‰åœ¨å“ªç¯‡æ—¥å¿—ä¸­å¥½åƒæåˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜â€¦ï¼‰ã€‚</p><p>19 &lt;= Build.VERSION.SDK_INT</p><div><pre><code>/**
 * Installer for platform versions 19.
 */
private static final class V19 {
    private static void install(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries,
            File optimizedDirectory)
                    throws IllegalArgumentException, IllegalAccessException,
                    NoSuchFieldException, InvocationTargetException, NoSuchMethodException {
        Field pathListField = findField(loader, &quot;pathList&quot;);
        Object dexPathList = pathListField.get(loader);
        ArrayList&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();
        expandFieldArray(dexPathList, &quot;dexElements&quot;, makeDexElements(dexPathList,
                new ArrayList&lt;File&gt;(additionalClassPathEntries), optimizedDirectory,
                suppressedExceptions));
        if (suppressedExceptions.size() &gt; 0) {
            for (IOException e : suppressedExceptions) {
                Log.w(TAG, &quot;Exception in makeDexElement&quot;, e);
            }
            Field suppressedExceptionsField =
                    findField(dexPathList, &quot;dexElementsSuppressedExceptions&quot;);
            IOException[] dexElementsSuppressedExceptions =
                    (IOException[]) suppressedExceptionsField.get(dexPathList);
            if (dexElementsSuppressedExceptions == null) {
                dexElementsSuppressedExceptions =
                        suppressedExceptions.toArray(
                                new IOException[suppressedExceptions.size()]);
            } else {
                IOException[] combined =
                        new IOException[suppressedExceptions.size() +
                                        dexElementsSuppressedExceptions.length];
                suppressedExceptions.toArray(combined);
                System.arraycopy(dexElementsSuppressedExceptions, 0, combined,
                        suppressedExceptions.size(), dexElementsSuppressedExceptions.length);
                dexElementsSuppressedExceptions = combined;
            }
            suppressedExceptionsField.set(dexPathList, dexElementsSuppressedExceptions);
        }
    }
    private static Object[] makeDexElements(
            Object dexPathList, ArrayList&lt;File&gt; files, File optimizedDirectory,
            ArrayList&lt;IOException&gt; suppressedExceptions)
                    throws IllegalAccessException, InvocationTargetException,
                    NoSuchMethodException {
        Method makeDexElements =
                findMethod(dexPathList, &quot;makeDexElements&quot;, ArrayList.class, File.class,
                        ArrayList.class);
        return (Object[]) makeDexElements.invoke(dexPathList, files, optimizedDirectory,
                suppressedExceptions);
    }
}
</code></pre></div><p>V19ä¸V14å·®åˆ«ä¸å¤§ï¼Œåªä¸è¿‡<strong>DexPathList#makeDexElements</strong>æ–¹æ³•å¤šäº†ä¸€ä¸ªArrayListå‚æ•°ï¼Œå¦‚æœåœ¨æ‰§è¡Œ<strong>DexPathList#makeDexElements</strong>æ–¹æ³•çš„è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œåé¢ä½¿ç”¨åå°„çš„æ–¹å¼æŠŠè¿™äº›å¼‚å¸¸è®°å½•è¿›DexPathListçš„<strong>dexElementsSuppressedExceptions</strong>å­—æ®µé‡Œé¢ã€‚</p><p>æ— è®ºæ˜¯V4/V14è¿˜æ˜¯V19ï¼Œåœ¨åˆ›å»ºDexFileå¯¹è±¡çš„æ—¶å€™ï¼Œéƒ½éœ€è¦é€šè¿‡DexFileçš„Nativeæ–¹æ³•<strong>openDexFile</strong>æ¥æ‰“å¼€dexæ–‡ä»¶ï¼Œå…¶å…·ä½“ç»†èŠ‚æš‚ä¸è®¨è®ºï¼ˆæ¶‰åŠåˆ°dexçš„æ–‡ä»¶ç»“æ„ï¼Œå¾ˆçƒ¦ï¼Œæœ‰å…´è¶£è¯·é˜…è¯»<a href="https://link.zhihu.com/?target=https%3A//android.googlesource.com/platform/dalvik/%2B/0dcf6bb/vm/native/dalvik_system_DexFile.cpp" target="_blank">dalvik_system_DexFile.cpp</a>ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ä¸»è¦ç›®çš„æ˜¯ç»™å½“å‰çš„dexæ–‡ä»¶åšOptimizeä¼˜åŒ–å¤„ç†å¹¶ç”Ÿæˆç›¸åŒæ–‡ä»¶åçš„odexæ–‡ä»¶ï¼ŒAppå®é™…åŠ è½½ç±»çš„æ—¶å€™ï¼Œéƒ½æ˜¯é€šè¿‡odexæ–‡ä»¶è¿›è¡Œçš„ã€‚å› ä¸ºæ¯ä¸ªè®¾å¤‡å¯¹odexæ ¼å¼çš„è¦æ±‚éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªä¼˜åŒ–çš„æ“ä½œåªèƒ½æ”¾åœ¨å®‰è£…Apkçš„æ—¶å€™å¤„ç†ï¼Œä¸»dexçš„ä¼˜åŒ–æˆ‘ä»¬å·²ç»åœ¨å®‰è£…apkçš„æ—¶å€™æå®šäº†ï¼Œå…¶ä½™çš„dexå°±æ˜¯åœ¨MultiDex#installSecondaryDexesé‡Œé¢ä¼˜åŒ–çš„ï¼Œè€Œåè€…ä¹Ÿæ˜¯MultiDexè¿‡ç¨‹ä¸­ï¼Œå¦å¤–ä¸€ä¸ªè€—æ—¶æ¯”è¾ƒå¤šçš„æ“ä½œã€‚ï¼ˆåœ¨MultiDexä¸­ï¼Œæå–å‡ºæ¥çš„dexæ–‡ä»¶è¢«å‹ç¼©æˆ.zipæ–‡ä»¶ï¼Œåˆä¼˜åŒ–åçš„odexæ–‡ä»¶åˆ™è¢«ä¿å­˜ä¸º.dexæ–‡ä»¶ã€‚ï¼‰</p><p>åˆ°è¿™é‡Œï¼ŒMultiDexçš„å·¥ä½œæµç¨‹å°±ç»“æŸäº†ã€‚æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å’Œä»¥å‰è°ˆåˆ°åŠ¨æ€åŠ è½½æŠ€æœ¯ï¼ˆæ’ä»¶åŒ–ï¼‰çš„æ—¶å€™è¯´çš„å¾ˆåƒï¼Ÿæ²¡é”™ï¼Œè°å«å®ƒä»¬çš„æ ¸å¿ƒéƒ½æ˜¯dexæ–‡ä»¶å‘¢ã€‚Javaè€å¸ˆç¬¬ä¸€èŠ‚è¯¾å°±è¯´â€œ<strong>ç±»å°±æ˜¯ç¼–ç¨‹</strong>â€ï¼Œæå®šç±»ä½ å°±èƒ½æå®šæ•´ä¸ªä¸–ç•Œå•Šï¼</p><h2>ä¼˜åŒ–æ–¹æ¡ˆ</h2><p>MultiDexæœ‰ä¸ªæ¯”è¾ƒè›‹ç–¼çš„é—®é¢˜ï¼Œå°±æ˜¯ä¼šäº§ç”Ÿæ˜æ˜¾çš„å¡é¡¿ç°è±¡ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“å…·ä½“çš„å¡é¡¿äº§ç”Ÿåœ¨<strong>è§£å‹dexæ–‡ä»¶</strong>ä»¥åŠ<strong>ä¼˜åŒ–dex</strong>ä¸¤ä¸ªæ­¥éª¤ã€‚ä¸è¿‡å¥½åœ¨ï¼Œåœ¨Application#attachBaseContext(Context)ä¸­ï¼ŒUIçº¿ç¨‹çš„é˜»å¡æ˜¯ä¸ä¼šå¼•å‘ANRçš„ï¼Œåªä¸è¿‡è¿™æ®µé•¿æ—¶é—´çš„å¡é¡¿ï¼ˆç™½å±ï¼‰è¿˜æ˜¯ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚</p><p>ç›®å‰ï¼Œä¼˜åŒ–æ–¹æ¡ˆèƒ½æƒ³åˆ°çš„æœ‰ä¸¤ç§ã€‚</p><h3>PreMultiDexæ–¹æ¡ˆ</h3><p>å¤§è‡´æ€è·¯æ˜¯ï¼Œåœ¨å®‰è£…ä¸€ä¸ªæ–°çš„apkçš„æ—¶å€™ï¼Œå…ˆåœ¨Workerçº¿ç¨‹é‡Œåšå¥½MultiDexçš„è§£å‹å’ŒOptimizeå·¥ä½œï¼Œå®‰è£…apkå¹¶å¯åŠ¨åï¼Œç›´æ¥ä½¿ç”¨ä¹‹å‰Optimizeäº§ç”Ÿçš„odexæ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶å€™çš„Optimizeå·¥ä½œã€‚</p><div><img src="MultiDexå·¥ä½œåŸç†åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ - ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ ANDROID - çŸ¥ä¹ä¸“æ _files/v2-d01206c54cb7c868cda21f60a696776f_b.png" type="image/png" data-filename="v2-d01206c54cb7c868cda21f60a696776f_b.png" height="567" width="576"/></div><p>å®‰è£…dexçš„æ—¶å€™ï¼Œæ ¸å¿ƒæ˜¯åˆ›å»ºDexFileå¯¹è±¡å¹¶ä½¿ç”¨å…¶Nativeæ–¹æ³•å¯¹dexæ–‡ä»¶è¿›è¡Œoptå¤„ç†ï¼ŒåŒæ—¶ç”Ÿäº§ä¸€ä¸ªä¸dexæ–‡ä»¶ï¼ˆ.zipï¼‰åŒåçš„å·²ç»optè¿‡çš„dexæ–‡ä»¶ï¼ˆ.dexï¼‰ã€‚å¦‚æœå®‰è£…dexçš„æ—¶å€™ï¼Œè¿™ä¸ªoptè¿‡çš„dexæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™è·³è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¼šèŠ‚çœè®¸å¤šè€—æ—¶ã€‚æ‰€ä»¥ä¼˜åŒ–çš„æ€è·¯å°±æ˜¯ï¼Œä¸‹è½½Apkå®Œæˆçš„æ—¶å€™ï¼Œé¢„å…ˆè§£å‹dexæ–‡ä»¶ï¼Œå¹¶é¢„å…ˆè§¦å‘å®‰è£…dexæ–‡ä»¶ä»¥ç”Ÿäº§optè¿‡çš„dexæ–‡ä»¶ã€‚è¿™æ ·è¦†ç›–å®‰è£…Apkå¹¶å¯åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœMultiDexèƒ½å‘½ä¸­è§£å‹å¥½çš„dexå’Œodexæ–‡ä»¶ï¼Œåˆ™èƒ½é¿å¼€è€—æ—¶æœ€å¤§çš„ä¸¤ä¸ªæ“ä½œã€‚</p><p>ä¸è¿‡è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹ä¹Ÿæ˜¯æ˜æ˜¾çš„ï¼Œç¬¬ä¸€æ¬¡å®‰è£…çš„apkæ²¡æœ‰ä½œç”¨ï¼Œè€Œä¸”äº‹å…ˆéœ€è¦ä½¿ç”¨å†…ç½®çš„apkæ›´æ–°åŠŸèƒ½æŠŠæ–°ç‰ˆæœ¬çš„apkæ–‡ä»¶ä¸‹è½½ä¸‹æ¥åï¼Œæ‰èƒ½åšPreMultiDexå·¥ä½œã€‚</p><h3>å¼‚æ­¥MultiDexæ–¹æ¡ˆ</h3><p>è¿™ç§æ–¹æ¡ˆä¹Ÿæ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„<strong>Dexæ‰‹åŠ¨åˆ†åŒ…æ–¹æ¡ˆ</strong>ï¼Œå¯åŠ¨Appçš„æ—¶å€™ï¼Œå…ˆæ˜¾ç¤ºä¸€ä¸ªç®€å•çš„Splashé—ªå±ç•Œé¢ï¼Œç„¶åå¯åŠ¨Workerçº¿ç¨‹æ‰§è¡ŒMultiDex#install(Context)å·¥ä½œï¼Œå°±å¯ä»¥é¿å…UIçº¿ç¨‹é˜»å¡ã€‚ä¸è¿‡è¦ç¡®ä¿å¯åŠ¨ä»¥åŠå¯åŠ¨MultiDex#install(Context)æ‰€éœ€è¦çš„ç±»éƒ½åœ¨ä¸»dexé‡Œé¢ï¼ˆæ‰‹åŠ¨åˆ†åŒ…ï¼‰ï¼Œè€Œä¸”éœ€è¦å¤„ç†å¥½è¿›ç¨‹åŒæ­¥é—®é¢˜ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p></div></div></div><br/></div></span>
</div></body></html> 